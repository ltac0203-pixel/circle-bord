# チケット P1-004: データベースマイグレーション

## 📋 概要
定義したEntityからTypeORMマイグレーションファイルを生成し、データベーススキーマを作成する。

## 🎯 目標
- 初期マイグレーションファイルの生成
- データベーススキーマの作成
- シードデータの準備
- マイグレーション管理の仕組み構築

## 📝 詳細説明

### 1. マイグレーション設定

**src/config/migration.ts:**
```typescript
import { DataSource } from 'typeorm';
import * as dotenv from 'dotenv';
import * as path from 'path';

dotenv.config({ path: '.env.local' });

export const MigrationDataSource = new DataSource({
  type: 'mariadb',
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '3306'),
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  synchronize: false,
  logging: true,
  entities: [path.join(__dirname, '../entities/**/*.{ts,js}')],
  migrations: [path.join(__dirname, '../migrations/**/*.{ts,js}')],
  migrationsTableName: 'migrations',
});
```

### 2. 初期マイグレーション生成

```bash
# マイグレーションディレクトリ作成
mkdir src/migrations

# 初期マイグレーション生成
npm run typeorm migration:generate -- src/migrations/InitialSchema -d src/config/migration.ts
```

生成されるマイグレーションファイルの例：

**src/migrations/[timestamp]-InitialSchema.ts:**
```typescript
import { MigrationInterface, QueryRunner } from "typeorm";

export class InitialSchema1234567890123 implements MigrationInterface {
    name = 'InitialSchema1234567890123'

    public async up(queryRunner: QueryRunner): Promise<void> {
        // Users table
        await queryRunner.query(`
            CREATE TABLE \`users\` (
                \`id\` varchar(36) NOT NULL,
                \`email\` varchar(255) NOT NULL,
                \`password\` varchar(255) NOT NULL,
                \`name\` varchar(100) NOT NULL,
                \`isActive\` tinyint NOT NULL DEFAULT 1,
                \`createdAt\` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
                \`updatedAt\` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
                UNIQUE INDEX \`IDX_email\` (\`email\`),
                PRIMARY KEY (\`id\`)
            ) ENGINE=InnoDB
        `);

        // Teams table
        await queryRunner.query(`
            CREATE TABLE \`teams\` (
                \`id\` int NOT NULL AUTO_INCREMENT,
                \`name\` varchar(100) NOT NULL,
                \`university\` varchar(100) NULL,
                \`contactEmail\` varchar(255) NULL,
                \`description\` text NULL,
                \`createdAt\` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
                \`createdById\` varchar(36) NULL,
                UNIQUE INDEX \`IDX_name\` (\`name\`),
                PRIMARY KEY (\`id\`)
            ) ENGINE=InnoDB
        `);

        // 他のテーブル作成クエリ...

        // 外部キー制約
        await queryRunner.query(`
            ALTER TABLE \`teams\` 
            ADD CONSTRAINT \`FK_teams_createdBy\` 
            FOREIGN KEY (\`createdById\`) 
            REFERENCES \`users\`(\`id\`) 
            ON DELETE SET NULL ON UPDATE NO ACTION
        `);

        // インデックス作成
        await queryRunner.query(`
            CREATE INDEX \`IDX_games_date_sport\` 
            ON \`games\` (\`date\`, \`sportId\`)
        `);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        // ロールバック処理
        await queryRunner.query(`DROP TABLE \`match_communications\``);
        await queryRunner.query(`DROP TABLE \`matches\``);
        await queryRunner.query(`DROP TABLE \`games\``);
        await queryRunner.query(`DROP TABLE \`user_teams\``);
        await queryRunner.query(`DROP TABLE \`locations\``);
        await queryRunner.query(`DROP TABLE \`sports\``);
        await queryRunner.query(`DROP TABLE \`teams\``);
        await queryRunner.query(`DROP TABLE \`users\``);
    }
}
```

### 3. シードデータ作成

**src/seeds/sports.seed.ts:**
```typescript
import { DataSource } from 'typeorm';
import { Sport } from '../entities/Sport';

export async function seedSports(dataSource: DataSource) {
  const sportRepository = dataSource.getRepository(Sport);
  
  const sports = [
    { name: 'サッカー', category: 'ball' },
    { name: 'バスケットボール', category: 'ball' },
    { name: 'バレーボール', category: 'ball' },
    { name: '野球', category: 'ball' },
    { name: 'テニス', category: 'individual' },
    { name: 'バドミントン', category: 'individual' },
    { name: '卓球', category: 'individual' },
    { name: 'ラグビー', category: 'team' },
    { name: 'ハンドボール', category: 'team' },
    { name: 'フットサル', category: 'ball' },
  ];

  for (const sportData of sports) {
    const existing = await sportRepository.findOne({ 
      where: { name: sportData.name } 
    });
    
    if (!existing) {
      const sport = sportRepository.create(sportData);
      await sportRepository.save(sport);
    }
  }
  
  console.log('✅ スポーツマスタデータ投入完了');
}
```

**src/seeds/locations.seed.ts:**
```typescript
import { DataSource } from 'typeorm';
import { Location } from '../entities/Location';

export async function seedLocations(dataSource: DataSource) {
  const locationRepository = dataSource.getRepository(Location);
  
  const locations = [
    {
      name: '東京体育館',
      address: '東京都渋谷区千駄ヶ谷1-17-1',
      prefecture: '東京都',
      city: '渋谷区'
    },
    {
      name: '代々木公園',
      address: '東京都渋谷区代々木神園町2-1',
      prefecture: '東京都',
      city: '渋谷区'
    },
    {
      name: '駒沢オリンピック公園',
      address: '東京都世田谷区駒沢公園1-1',
      prefecture: '東京都',
      city: '世田谷区'
    },
    // 他の場所データ...
  ];

  for (const locationData of locations) {
    const existing = await locationRepository.findOne({ 
      where: { name: locationData.name } 
    });
    
    if (!existing) {
      const location = locationRepository.create(locationData);
      await locationRepository.save(location);
    }
  }
  
  console.log('✅ 場所マスタデータ投入完了');
}
```

**src/seeds/index.ts:**
```typescript
import 'reflect-metadata';
import { AppDataSource } from '../config/database';
import { seedSports } from './sports.seed';
import { seedLocations } from './locations.seed';

async function runSeeds() {
  try {
    await AppDataSource.initialize();
    console.log('📝 シードデータ投入開始...');
    
    await seedSports(AppDataSource);
    await seedLocations(AppDataSource);
    
    console.log('✅ すべてのシードデータ投入完了');
    await AppDataSource.destroy();
  } catch (error) {
    console.error('❌ シードデータ投入エラー:', error);
    process.exit(1);
  }
}

runSeeds();
```

### 4. マイグレーション管理スクリプト

**package.json更新:**
```json
{
  "scripts": {
    "migration:generate": "typeorm-ts-node-commonjs migration:generate -d src/config/migration.ts",
    "migration:create": "typeorm-ts-node-commonjs migration:create",
    "migration:run": "typeorm-ts-node-commonjs migration:run -d src/config/migration.ts",
    "migration:revert": "typeorm-ts-node-commonjs migration:revert -d src/config/migration.ts",
    "migration:show": "typeorm-ts-node-commonjs migration:show -d src/config/migration.ts",
    "seed:run": "ts-node src/seeds/index.ts",
    "db:reset": "npm run migration:revert && npm run migration:run && npm run seed:run"
  }
}
```

### 5. マイグレーション実行手順

```bash
# 1. マイグレーション実行
npm run migration:run

# 2. マイグレーション状態確認
npm run migration:show

# 3. シードデータ投入
npm run seed:run

# 4. データベースリセット（開発時）
npm run db:reset
```

## ✅ 受け入れ条件

- [ ] 初期マイグレーションファイルが生成されている
- [ ] すべてのテーブルが正しく作成される
- [ ] 外部キー制約が適切に設定される
- [ ] インデックスが作成される
- [ ] シードデータが投入できる
- [ ] マイグレーションのロールバックが可能
- [ ] マイグレーション履歴が管理される

## 🔧 技術要件

- TypeORM マイグレーション機能
- MariaDB対応SQL
- トランザクション処理

## ⏱️ 見積もり時間
8時間

## 🔗 依存関係
- P1-003: Entity定義実装（完了必須）

## 🧪 テスト方針

### マイグレーションテスト
```bash
# 1. マイグレーション実行
npm run migration:run

# 2. テーブル存在確認
mysql -u circle_user -p circle_bord -e "SHOW TABLES;"

# 3. スキーマ確認
mysql -u circle_user -p circle_bord -e "DESCRIBE users;"
mysql -u circle_user -p circle_bord -e "DESCRIBE teams;"

# 4. 外部キー確認
mysql -u circle_user -p circle_bord -e "
  SELECT 
    TABLE_NAME, COLUMN_NAME, 
    CONSTRAINT_NAME, REFERENCED_TABLE_NAME, 
    REFERENCED_COLUMN_NAME 
  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
  WHERE REFERENCED_TABLE_NAME IS NOT NULL 
    AND TABLE_SCHEMA = 'circle_bord';
"

# 5. ロールバックテスト
npm run migration:revert
```

## 📌 注意事項

- 本番環境では`synchronize: false`を必ず設定
- マイグレーションは必ずレビュー後に実行
- 破壊的変更は慎重に検討
- バックアップを取ってから実行
- トランザクション内で実行されることを確認

## 🏷️ ラベル
`migration`, `database`, `schema`, `phase1`

## 📅 作成日
2025-09-08