# ãƒã‚±ãƒƒãƒˆ P1-004: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

## ğŸ“‹ æ¦‚è¦
å®šç¾©ã—ãŸEntityã‹ã‚‰TypeORMãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ
- ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã®ä»•çµ„ã¿æ§‹ç¯‰

## ğŸ“ è©³ç´°èª¬æ˜

### 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

**src/config/migration.ts:**
```typescript
import { DataSource } from 'typeorm';
import * as dotenv from 'dotenv';
import * as path from 'path';

dotenv.config({ path: '.env.local' });

export const MigrationDataSource = new DataSource({
  type: 'mariadb',
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '3306'),
  username: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  synchronize: false,
  logging: true,
  entities: [path.join(__dirname, '../entities/**/*.{ts,js}')],
  migrations: [path.join(__dirname, '../migrations/**/*.{ts,js}')],
  migrationsTableName: 'migrations',
});
```

### 2. åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir src/migrations

# åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
npm run typeorm migration:generate -- src/migrations/InitialSchema -d src/config/migration.ts
```

ç”Ÿæˆã•ã‚Œã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¾‹ï¼š

**src/migrations/[timestamp]-InitialSchema.ts:**
```typescript
import { MigrationInterface, QueryRunner } from "typeorm";

export class InitialSchema1234567890123 implements MigrationInterface {
    name = 'InitialSchema1234567890123'

    public async up(queryRunner: QueryRunner): Promise<void> {
        // Users table
        await queryRunner.query(`
            CREATE TABLE \`users\` (
                \`id\` varchar(36) NOT NULL,
                \`email\` varchar(255) NOT NULL,
                \`password\` varchar(255) NOT NULL,
                \`name\` varchar(100) NOT NULL,
                \`isActive\` tinyint NOT NULL DEFAULT 1,
                \`createdAt\` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
                \`updatedAt\` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
                UNIQUE INDEX \`IDX_email\` (\`email\`),
                PRIMARY KEY (\`id\`)
            ) ENGINE=InnoDB
        `);

        // Teams table
        await queryRunner.query(`
            CREATE TABLE \`teams\` (
                \`id\` int NOT NULL AUTO_INCREMENT,
                \`name\` varchar(100) NOT NULL,
                \`university\` varchar(100) NULL,
                \`contactEmail\` varchar(255) NULL,
                \`description\` text NULL,
                \`createdAt\` datetime(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
                \`createdById\` varchar(36) NULL,
                UNIQUE INDEX \`IDX_name\` (\`name\`),
                PRIMARY KEY (\`id\`)
            ) ENGINE=InnoDB
        `);

        // ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚¯ã‚¨ãƒª...

        // å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„
        await queryRunner.query(`
            ALTER TABLE \`teams\` 
            ADD CONSTRAINT \`FK_teams_createdBy\` 
            FOREIGN KEY (\`createdById\`) 
            REFERENCES \`users\`(\`id\`) 
            ON DELETE SET NULL ON UPDATE NO ACTION
        `);

        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
        await queryRunner.query(`
            CREATE INDEX \`IDX_games_date_sport\` 
            ON \`games\` (\`date\`, \`sportId\`)
        `);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
        await queryRunner.query(`DROP TABLE \`match_communications\``);
        await queryRunner.query(`DROP TABLE \`matches\``);
        await queryRunner.query(`DROP TABLE \`games\``);
        await queryRunner.query(`DROP TABLE \`user_teams\``);
        await queryRunner.query(`DROP TABLE \`locations\``);
        await queryRunner.query(`DROP TABLE \`sports\``);
        await queryRunner.query(`DROP TABLE \`teams\``);
        await queryRunner.query(`DROP TABLE \`users\``);
    }
}
```

### 3. ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ä½œæˆ

**src/seeds/sports.seed.ts:**
```typescript
import { DataSource } from 'typeorm';
import { Sport } from '../entities/Sport';

export async function seedSports(dataSource: DataSource) {
  const sportRepository = dataSource.getRepository(Sport);
  
  const sports = [
    { name: 'ã‚µãƒƒã‚«ãƒ¼', category: 'ball' },
    { name: 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', category: 'ball' },
    { name: 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«', category: 'ball' },
    { name: 'é‡çƒ', category: 'ball' },
    { name: 'ãƒ†ãƒ‹ã‚¹', category: 'individual' },
    { name: 'ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³', category: 'individual' },
    { name: 'å“çƒ', category: 'individual' },
    { name: 'ãƒ©ã‚°ãƒ“ãƒ¼', category: 'team' },
    { name: 'ãƒãƒ³ãƒ‰ãƒœãƒ¼ãƒ«', category: 'team' },
    { name: 'ãƒ•ãƒƒãƒˆã‚µãƒ«', category: 'ball' },
  ];

  for (const sportData of sports) {
    const existing = await sportRepository.findOne({ 
      where: { name: sportData.name } 
    });
    
    if (!existing) {
      const sport = sportRepository.create(sportData);
      await sportRepository.save(sport);
    }
  }
  
  console.log('âœ… ã‚¹ãƒãƒ¼ãƒ„ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†');
}
```

**src/seeds/locations.seed.ts:**
```typescript
import { DataSource } from 'typeorm';
import { Location } from '../entities/Location';

export async function seedLocations(dataSource: DataSource) {
  const locationRepository = dataSource.getRepository(Location);
  
  const locations = [
    {
      name: 'æ±äº¬ä½“è‚²é¤¨',
      address: 'æ±äº¬éƒ½æ¸‹è°·åŒºåƒé§„ãƒ¶è°·1-17-1',
      prefecture: 'æ±äº¬éƒ½',
      city: 'æ¸‹è°·åŒº'
    },
    {
      name: 'ä»£ã€…æœ¨å…¬åœ’',
      address: 'æ±äº¬éƒ½æ¸‹è°·åŒºä»£ã€…æœ¨ç¥åœ’ç”º2-1',
      prefecture: 'æ±äº¬éƒ½',
      city: 'æ¸‹è°·åŒº'
    },
    {
      name: 'é§’æ²¢ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯å…¬åœ’',
      address: 'æ±äº¬éƒ½ä¸–ç”°è°·åŒºé§’æ²¢å…¬åœ’1-1',
      prefecture: 'æ±äº¬éƒ½',
      city: 'ä¸–ç”°è°·åŒº'
    },
    // ä»–ã®å ´æ‰€ãƒ‡ãƒ¼ã‚¿...
  ];

  for (const locationData of locations) {
    const existing = await locationRepository.findOne({ 
      where: { name: locationData.name } 
    });
    
    if (!existing) {
      const location = locationRepository.create(locationData);
      await locationRepository.save(location);
    }
  }
  
  console.log('âœ… å ´æ‰€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†');
}
```

**src/seeds/index.ts:**
```typescript
import 'reflect-metadata';
import { AppDataSource } from '../config/database';
import { seedSports } from './sports.seed';
import { seedLocations } from './locations.seed';

async function runSeeds() {
  try {
    await AppDataSource.initialize();
    console.log('ğŸ“ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥é–‹å§‹...');
    
    await seedSports(AppDataSource);
    await seedLocations(AppDataSource);
    
    console.log('âœ… ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥å®Œäº†');
    await AppDataSource.destroy();
  } catch (error) {
    console.error('âŒ ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ã‚¨ãƒ©ãƒ¼:', error);
    process.exit(1);
  }
}

runSeeds();
```

### 4. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**package.jsonæ›´æ–°:**
```json
{
  "scripts": {
    "migration:generate": "typeorm-ts-node-commonjs migration:generate -d src/config/migration.ts",
    "migration:create": "typeorm-ts-node-commonjs migration:create",
    "migration:run": "typeorm-ts-node-commonjs migration:run -d src/config/migration.ts",
    "migration:revert": "typeorm-ts-node-commonjs migration:revert -d src/config/migration.ts",
    "migration:show": "typeorm-ts-node-commonjs migration:show -d src/config/migration.ts",
    "seed:run": "ts-node src/seeds/index.ts",
    "db:reset": "npm run migration:revert && npm run migration:run && npm run seed:run"
  }
}
```

### 5. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †

```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
npm run migration:run

# 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
npm run migration:show

# 3. ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
npm run seed:run

# 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆï¼ˆé–‹ç™ºæ™‚ï¼‰
npm run db:reset
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹
- [ ] ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ­£ã—ãä½œæˆã•ã‚Œã‚‹
- [ ] å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã‚‹
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œã‚‹
- [ ] ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒæŠ•å…¥ã§ãã‚‹
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¯èƒ½
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ãŒç®¡ç†ã•ã‚Œã‚‹

## ğŸ”§ æŠ€è¡“è¦ä»¶

- TypeORM ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- MariaDBå¯¾å¿œSQL
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
8æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P1-003: Entityå®šç¾©å®Ÿè£…ï¼ˆå®Œäº†å¿…é ˆï¼‰

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
```bash
# 1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
npm run migration:run

# 2. ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
mysql -u circle_user -p circle_bord -e "SHOW TABLES;"

# 3. ã‚¹ã‚­ãƒ¼ãƒç¢ºèª
mysql -u circle_user -p circle_bord -e "DESCRIBE users;"
mysql -u circle_user -p circle_bord -e "DESCRIBE teams;"

# 4. å¤–éƒ¨ã‚­ãƒ¼ç¢ºèª
mysql -u circle_user -p circle_bord -e "
  SELECT 
    TABLE_NAME, COLUMN_NAME, 
    CONSTRAINT_NAME, REFERENCED_TABLE_NAME, 
    REFERENCED_COLUMN_NAME 
  FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
  WHERE REFERENCED_TABLE_NAME IS NOT NULL 
    AND TABLE_SCHEMA = 'circle_bord';
"

# 5. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
npm run migration:revert
```

## ğŸ“Œ æ³¨æ„äº‹é …

- æœ¬ç•ªç’°å¢ƒã§ã¯`synchronize: false`ã‚’å¿…ãšè¨­å®š
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯å¿…ãšãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«å®Ÿè¡Œ
- ç ´å£Šçš„å¤‰æ›´ã¯æ…é‡ã«æ¤œè¨
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`migration`, `database`, `schema`, `phase1`

## ğŸ“… ä½œæˆæ—¥
2025-09-08