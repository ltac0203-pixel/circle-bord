# チケット P1-006: Swagger文書化

## 📋 概要
OpenAPI 3.0仕様に基づいてAPIドキュメントを作成し、Swagger UIで閲覧可能にする。

## 🎯 目標
- OpenAPI仕様書の作成
- Swagger UIの統合
- APIエンドポイントの文書化
- リクエスト/レスポンスサンプルの追加
- 認証仕様の文書化

## 📝 詳細説明

### 1. 必要パッケージのインストール

```bash
npm install swagger-jsdoc swagger-ui-express
npm install -D @types/swagger-jsdoc @types/swagger-ui-express
```

### 2. Swagger設定

**src/config/swagger.ts:**
```typescript
import swaggerJsdoc from 'swagger-jsdoc';

const options: swaggerJsdoc.Options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'Circle-Bord API',
      version: '1.0.0',
      description: '大学サークル練習試合マッチングプラットフォーム API',
      contact: {
        name: 'API Support',
        email: 'support@circle-bord.com'
      }
    },
    servers: [
      {
        url: 'http://localhost:3001/api',
        description: '開発サーバー'
      },
      {
        url: 'https://api.circle-bord.com',
        description: '本番サーバー'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      },
      schemas: {
        Error: {
          type: 'object',
          properties: {
            message: {
              type: 'string',
              description: 'エラーメッセージ'
            },
            code: {
              type: 'string',
              description: 'エラーコード'
            },
            statusCode: {
              type: 'integer',
              description: 'HTTPステータスコード'
            }
          }
        },
        Pagination: {
          type: 'object',
          properties: {
            page: {
              type: 'integer',
              description: '現在のページ番号'
            },
            limit: {
              type: 'integer',
              description: '1ページあたりの件数'
            },
            total: {
              type: 'integer',
              description: '総件数'
            },
            totalPages: {
              type: 'integer',
              description: '総ページ数'
            }
          }
        }
      }
    },
    tags: [
      {
        name: 'Auth',
        description: '認証関連のAPI'
      },
      {
        name: 'Users',
        description: 'ユーザー管理API'
      },
      {
        name: 'Teams',
        description: 'チーム管理API'
      },
      {
        name: 'Games',
        description: '試合管理API'
      },
      {
        name: 'Matches',
        description: 'マッチング管理API'
      },
      {
        name: 'Master',
        description: 'マスタデータAPI'
      }
    ]
  },
  apis: ['./src/routes/**/*.ts', './src/controllers/**/*.ts']
};

export const specs = swaggerJsdoc(options);
```

### 3. Swagger UI統合

**src/app.ts更新:**
```typescript
import swaggerUi from 'swagger-ui-express';
import { specs } from './config/swagger';

// Swagger UI
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs, {
  customCss: '.swagger-ui .topbar { display: none }',
  customSiteTitle: 'Circle-Bord API Documentation'
}));
```

### 4. APIエンドポイント文書化

**src/controllers/UserController.ts（文書化追加）:**
```typescript
/**
 * @swagger
 * components:
 *   schemas:
 *     User:
 *       type: object
 *       required:
 *         - email
 *         - name
 *         - password
 *       properties:
 *         id:
 *           type: string
 *           format: uuid
 *           description: ユーザーID
 *         email:
 *           type: string
 *           format: email
 *           description: メールアドレス
 *         name:
 *           type: string
 *           description: ユーザー名
 *         isActive:
 *           type: boolean
 *           description: アクティブ状態
 *         createdAt:
 *           type: string
 *           format: date-time
 *           description: 作成日時
 *         updatedAt:
 *           type: string
 *           format: date-time
 *           description: 更新日時
 */

export class UserController {
  /**
   * @swagger
   * /users:
   *   get:
   *     summary: ユーザー一覧取得
   *     tags: [Users]
   *     security:
   *       - bearerAuth: []
   *     parameters:
   *       - in: query
   *         name: page
   *         schema:
   *           type: integer
   *           default: 1
   *         description: ページ番号
   *       - in: query
   *         name: limit
   *         schema:
   *           type: integer
   *           default: 10
   *         description: 1ページあたりの件数
   *     responses:
   *       200:
   *         description: ユーザー一覧
   *         content:
   *           application/json:
   *             schema:
   *               type: object
   *               properties:
   *                 data:
   *                   type: array
   *                   items:
   *                     $ref: '#/components/schemas/User'
   *                 pagination:
   *                   $ref: '#/components/schemas/Pagination'
   *       401:
   *         description: 認証エラー
   *         content:
   *           application/json:
   *             schema:
   *               $ref: '#/components/schemas/Error'
   */
  async getAll = async (req: Request, res: Response, next: NextFunction) => {
    // 実装...
  };

  /**
   * @swagger
   * /users/{id}:
   *   get:
   *     summary: ユーザー詳細取得
   *     tags: [Users]
   *     security:
   *       - bearerAuth: []
   *     parameters:
   *       - in: path
   *         name: id
   *         required: true
   *         schema:
   *           type: string
   *           format: uuid
   *         description: ユーザーID
   *     responses:
   *       200:
   *         description: ユーザー詳細
   *         content:
   *           application/json:
   *             schema:
   *               $ref: '#/components/schemas/User'
   *       404:
   *         description: ユーザーが見つかりません
   *         content:
   *           application/json:
   *             schema:
   *               $ref: '#/components/schemas/Error'
   */
  async getById = async (req: Request, res: Response, next: NextFunction) => {
    // 実装...
  };

  /**
   * @swagger
   * /users:
   *   post:
   *     summary: ユーザー作成
   *     tags: [Users]
   *     requestBody:
   *       required: true
   *       content:
   *         application/json:
   *           schema:
   *             type: object
   *             required:
   *               - email
   *               - password
   *               - name
   *             properties:
   *               email:
   *                 type: string
   *                 format: email
   *                 example: user@example.com
   *               password:
   *                 type: string
   *                 format: password
   *                 minLength: 6
   *                 example: password123
   *               name:
   *                 type: string
   *                 example: 山田太郎
   *     responses:
   *       201:
   *         description: ユーザー作成成功
   *         content:
   *           application/json:
   *             schema:
   *               $ref: '#/components/schemas/User'
   *       400:
   *         description: バリデーションエラー
   *       409:
   *         description: メールアドレス重複
   */
  async create = async (req: Request, res: Response, next: NextFunction) => {
    // 実装...
  };
}
```

### 5. Game API文書化例

```typescript
/**
 * @swagger
 * components:
 *   schemas:
 *     Game:
 *       type: object
 *       properties:
 *         id:
 *           type: integer
 *           description: 試合ID
 *         teamId:
 *           type: integer
 *           description: チームID
 *         sportId:
 *           type: integer
 *           description: スポーツID
 *         locationId:
 *           type: integer
 *           description: 場所ID
 *         date:
 *           type: string
 *           format: date
 *           description: 試合日
 *         startTime:
 *           type: string
 *           format: time
 *           description: 開始時刻
 *         endTime:
 *           type: string
 *           format: time
 *           description: 終了時刻
 *         status:
 *           type: string
 *           enum: [open, matched, completed, cancelled]
 *           description: ステータス
 *         contact:
 *           type: string
 *           description: 連絡先
 *         description:
 *           type: string
 *           description: 詳細説明
 *         maxParticipants:
 *           type: integer
 *           description: 最大参加人数
 * 
 * /games/search:
 *   get:
 *     summary: 試合検索
 *     tags: [Games]
 *     parameters:
 *       - in: query
 *         name: sportId
 *         schema:
 *           type: integer
 *         description: スポーツID
 *       - in: query
 *         name: locationId
 *         schema:
 *           type: integer
 *         description: 場所ID
 *       - in: query
 *         name: date
 *         schema:
 *           type: string
 *           format: date
 *         description: 試合日
 *       - in: query
 *         name: status
 *         schema:
 *           type: string
 *           enum: [open, matched, completed, cancelled]
 *         description: ステータス
 *     responses:
 *       200:
 *         description: 検索結果
 *         content:
 *           application/json:
 *             schema:
 *               type: array
 *               items:
 *                 $ref: '#/components/schemas/Game'
 */
```

### 6. 認証API文書化

```typescript
/**
 * @swagger
 * /auth/login:
 *   post:
 *     summary: ログイン
 *     tags: [Auth]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - email
 *               - password
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *                 example: user@example.com
 *               password:
 *                 type: string
 *                 format: password
 *                 example: password123
 *     responses:
 *       200:
 *         description: ログイン成功
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 token:
 *                   type: string
 *                   description: JWTトークン
 *                 user:
 *                   $ref: '#/components/schemas/User'
 *       401:
 *         description: 認証失敗
 */
```

### 7. APIドキュメント自動生成スクリプト

**scripts/generate-api-spec.ts:**
```typescript
import fs from 'fs';
import { specs } from '../src/config/swagger';

const outputPath = './docs/api/openapi.json';

fs.writeFileSync(outputPath, JSON.stringify(specs, null, 2));
console.log(`API仕様書を生成しました: ${outputPath}`);
```

## ✅ 受け入れ条件

- [ ] Swagger UIが `/api-docs` でアクセス可能
- [ ] すべてのAPIエンドポイントが文書化されている
- [ ] リクエスト/レスポンスの型が定義されている
- [ ] エラーレスポンスが文書化されている
- [ ] 認証が必要なエンドポイントが明示されている
- [ ] サンプルデータが提供されている
- [ ] OpenAPI仕様書がエクスポート可能

## 🔧 技術要件

- OpenAPI 3.0
- swagger-jsdoc
- swagger-ui-express

## ⏱️ 見積もり時間
8時間

## 🔗 依存関係
- P1-005: CRUD API実装（完了必須）

## 🧪 テスト方針

### Swagger UI確認
1. `http://localhost:3001/api-docs` にアクセス
2. 各エンドポイントの文書が表示されることを確認
3. "Try it out"機能でAPIテストが可能なことを確認
4. 認証トークンが設定できることを確認

### OpenAPI仕様検証
```bash
# OpenAPI仕様書の検証
npx @apidevtools/swagger-cli validate docs/api/openapi.json
```

## 📌 注意事項

- パスワードなど機密情報はサンプルに含めない
- レスポンスのサンプルは実際のデータ構造と一致させる
- 非推奨（deprecated）のAPIは明示する
- バージョニング戦略を検討する

## 🏷️ ラベル
`documentation`, `swagger`, `api`, `phase1`

## 📅 作成日
2025-09-08