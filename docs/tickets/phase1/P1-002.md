# チケット P1-002: バックエンドプロジェクト初期化

## 📋 概要
TypeScript + Express + TypeORMを使用したバックエンドAPIサーバーの初期プロジェクトをセットアップする。

## 🎯 目標
- Node.js/TypeScriptプロジェクトの初期化
- Express.jsサーバーの基本設定
- TypeORMの設定とデータベース接続
- 開発環境の構築（hot reload対応）

## 📝 詳細説明

### 1. プロジェクトディレクトリ作成
```bash
# バックエンドプロジェクトを別ディレクトリとして作成
mkdir circle-bord-backend
cd circle-bord-backend

# Gitリポジトリ初期化
git init
```

### 2. package.json初期化と依存関係インストール
```bash
# package.json作成
npm init -y

# 本番依存関係
npm install express cors helmet morgan compression
npm install typeorm reflect-metadata mysql2
npm install dotenv
npm install bcrypt jsonwebtoken
npm install class-validator class-transformer

# 開発依存関係
npm install -D typescript @types/node
npm install -D @types/express @types/cors @types/morgan @types/compression
npm install -D @types/bcrypt @types/jsonwebtoken
npm install -D ts-node nodemon
npm install -D @typescript-eslint/parser @typescript-eslint/eslint-plugin
npm install -D prettier eslint
```

### 3. TypeScript設定（tsconfig.json）
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "experimentalDecorators": true,
    "emitDecoratorMetadata": true,
    "resolveJsonModule": true,
    "sourceMap": true,
    "noImplicitAny": true,
    "strictPropertyInitialization": false
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 4. プロジェクト構造作成
```
circle-bord-backend/
├── src/
│   ├── config/
│   │   ├── database.ts
│   │   └── config.ts
│   ├── entities/
│   │   └── index.ts
│   ├── repositories/
│   ├── services/
│   ├── controllers/
│   ├── middlewares/
│   │   └── errorHandler.ts
│   ├── routes/
│   │   └── index.ts
│   ├── utils/
│   │   └── logger.ts
│   └── app.ts
│   └── server.ts
├── .env.example
├── .env.local
├── .gitignore
├── .eslintrc.json
├── .prettierrc
├── nodemon.json
├── package.json
└── tsconfig.json
```

### 5. 基本的なサーバー実装

**src/config/database.ts:**
```typescript
import { DataSource, DataSourceOptions } from 'typeorm';
import * as dotenv from 'dotenv';

dotenv.config({ path: '.env.local' });

const config: DataSourceOptions = {
  type: 'mariadb',
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '3306'),
  username: process.env.DB_USER || 'circle_user',
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME || 'circle_bord',
  synchronize: process.env.NODE_ENV === 'development',
  logging: process.env.NODE_ENV === 'development',
  entities: ['src/entities/**/*.ts'],
  migrations: ['src/migrations/**/*.ts'],
  subscribers: ['src/subscribers/**/*.ts'],
};

export const AppDataSource = new DataSource(config);
```

**src/app.ts:**
```typescript
import express, { Application } from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import compression from 'compression';
import { errorHandler } from './middlewares/errorHandler';
import routes from './routes';

const app: Application = express();

// ミドルウェア
app.use(helmet());
app.use(cors());
app.use(compression());
app.use(morgan('dev'));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ルート
app.use('/api', routes);

// ヘルスチェック
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// エラーハンドリング
app.use(errorHandler);

export default app;
```

**src/server.ts:**
```typescript
import 'reflect-metadata';
import { AppDataSource } from './config/database';
import app from './app';
import * as dotenv from 'dotenv';

dotenv.config({ path: '.env.local' });

const PORT = process.env.PORT || 3001;

const startServer = async () => {
  try {
    // データベース接続
    await AppDataSource.initialize();
    console.log('✅ データベース接続成功');

    // サーバー起動
    app.listen(PORT, () => {
      console.log(`🚀 サーバー起動: http://localhost:${PORT}`);
      console.log(`📝 API文書: http://localhost:${PORT}/api-docs`);
    });
  } catch (error) {
    console.error('❌ サーバー起動エラー:', error);
    process.exit(1);
  }
};

startServer();
```

### 6. 開発環境設定

**nodemon.json:**
```json
{
  "watch": ["src"],
  "ext": "ts",
  "ignore": ["src/**/*.spec.ts"],
  "exec": "ts-node ./src/server.ts"
}
```

**package.jsonスクリプト:**
```json
{
  "scripts": {
    "dev": "nodemon",
    "build": "tsc",
    "start": "node dist/server.js",
    "typeorm": "typeorm-ts-node-commonjs",
    "migration:generate": "npm run typeorm migration:generate -- -d src/config/database.ts",
    "migration:run": "npm run typeorm migration:run -- -d src/config/database.ts",
    "lint": "eslint . --ext .ts",
    "format": "prettier --write \"src/**/*.ts\""
  }
}
```

## ✅ 受け入れ条件

- [ ] TypeScriptプロジェクトが正しく設定されている
- [ ] Express サーバーが起動する（ポート3001）
- [ ] TypeORMでデータベースに接続できる
- [ ] ヘルスチェックエンドポイント `/health` が動作する
- [ ] Hot reload（nodemon）が機能する
- [ ] ESLintとPrettierが設定されている
- [ ] プロジェクト構造が整理されている

## 🔧 技術要件

- Node.js 20以上
- TypeScript 5.0以上
- Express.js 4.x
- TypeORM 0.3.x
- MariaDB接続対応

## ⏱️ 見積もり時間
8時間

## 🔗 依存関係
- P1-001: MariaDB環境セットアップ（完了必須）

## 🧪 テスト方針

### 起動確認
```bash
# 開発サーバー起動
npm run dev

# ヘルスチェック
curl http://localhost:3001/health

# TypeScript コンパイル確認
npm run build

# Lint実行
npm run lint
```

### 接続テスト
```typescript
// test/db-connection.test.ts
import { AppDataSource } from '../src/config/database';

describe('Database Connection', () => {
  it('should connect to database', async () => {
    await expect(AppDataSource.initialize()).resolves.toBeTruthy();
    await AppDataSource.destroy();
  });
});
```

## 📌 注意事項

- `.env.local`ファイルは`.gitignore`に必ず追加
- TypeORMの`synchronize`は本番環境では必ずfalseに設定
- CORSの設定は本番環境では適切に制限すること
- ポート番号はフロントエンド（3000）と重複しないように設定

## 🏷️ ラベル
`setup`, `backend`, `infrastructure`, `phase1`

## 📅 作成日
2025-09-08