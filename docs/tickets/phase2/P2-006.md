# ãƒã‚±ãƒƒãƒˆ P2-006: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–

## ğŸ“‹ æ¦‚è¦
èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

## ğŸ“ è©³ç´°èª¬æ˜

### 1. ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹

**src/errors/AppError.ts:**
```typescript
export class AppError extends Error {
  public readonly statusCode: number;
  public readonly code: string;
  public readonly isOperational: boolean;

  constructor(
    message: string,
    statusCode: number,
    code: string,
    isOperational = true
  ) {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
    this.isOperational = isOperational;

    Error.captureStackTrace(this, this.constructor);
  }
}

export class ValidationError extends AppError {
  constructor(message: string, code = 'VALIDATION_ERROR') {
    super(message, 400, code);
  }
}

export class AuthenticationError extends AppError {
  constructor(message = 'èªè¨¼ãŒå¿…è¦ã§ã™', code = 'AUTH_REQUIRED') {
    super(message, 401, code);
  }
}

export class ForbiddenError extends AppError {
  constructor(message = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“', code = 'FORBIDDEN') {
    super(message, 403, code);
  }
}

export class NotFoundError extends AppError {
  constructor(message = 'ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', code = 'NOT_FOUND') {
    super(message, 404, code);
  }
}

export class ConflictError extends AppError {
  constructor(message = 'ãƒªã‚½ãƒ¼ã‚¹ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™', code = 'CONFLICT') {
    super(message, 409, code);
  }
}

export class RateLimitError extends AppError {
  constructor(message = 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŒåˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸ', code = 'RATE_LIMIT') {
    super(message, 429, code);
  }
}
```

### 2. ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

**src/middlewares/errorHandler.ts:**
```typescript
import { Request, Response, NextFunction } from 'express';
import { AppError } from '../errors/AppError';
import { logger } from '../utils/logger';

export const errorHandler = (
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
): void => {
  // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°è¨˜éŒ²
  logger.error({
    error: err.message,
    stack: err.stack,
    url: req.url,
    method: req.method,
    ip: req.ip,
    userId: req.user?.id
  });

  // AppErrorã®å ´åˆ
  if (err instanceof AppError) {
    res.status(err.statusCode).json({
      error: {
        message: err.message,
        code: err.code,
        statusCode: err.statusCode
      }
    });
    return;
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆclass-validatorï¼‰
  if (err.name === 'ValidationError') {
    res.status(400).json({
      error: {
        message: 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼',
        code: 'VALIDATION_ERROR',
        statusCode: 400,
        details: err.message
      }
    });
    return;
  }

  // JWTé–¢é€£ã‚¨ãƒ©ãƒ¼
  if (err.name === 'JsonWebTokenError') {
    res.status(401).json({
      error: {
        message: 'ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã§ã™',
        code: 'INVALID_TOKEN',
        statusCode: 401
      }
    });
    return;
  }

  if (err.name === 'TokenExpiredError') {
    res.status(401).json({
      error: {
        message: 'ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™',
        code: 'TOKEN_EXPIRED',
        statusCode: 401
      }
    });
    return;
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
  if (err.name === 'QueryFailedError') {
    res.status(500).json({
      error: {
        message: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
        code: 'DATABASE_ERROR',
        statusCode: 500
      }
    });
    return;
  }

  // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
  const isDevelopment = process.env.NODE_ENV === 'development';
  res.status(500).json({
    error: {
      message: isDevelopment ? err.message : 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      code: 'INTERNAL_SERVER_ERROR',
      statusCode: 500,
      ...(isDevelopment && { stack: err.stack })
    }
  });
};

// éåŒæœŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ©ãƒƒãƒ‘ãƒ¼
export const asyncHandler = (fn: Function) => {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚®ãƒ³ã‚°

**src/utils/logger.ts:**
```typescript
import winston from 'winston';
import path from 'path';

const logDir = 'logs';

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp({
      format: 'YYYY-MM-DD HH:mm:ss'
    }),
    winston.format.errors({ stack: true }),
    winston.format.splat(),
    winston.format.json()
  ),
  defaultMeta: { service: 'circle-bord-api' },
  transports: [
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
    new winston.transports.File({
      filename: path.join(logDir, 'error.log'),
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 5
    }),
    // å…¨ãƒ­ã‚°
    new winston.transports.File({
      filename: path.join(logDir, 'combined.log'),
      maxsize: 5242880,
      maxFiles: 5
    })
  ]
});

// é–‹ç™ºç’°å¢ƒã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }));
}

export { logger };
```

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**src/utils/errorHandler.ts (ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰):**
```typescript
import { AxiosError } from 'axios';

interface ErrorResponse {
  message: string;
  code: string;
  statusCode: number;
  details?: any;
}

export const handleApiError = (error: unknown): string => {
  if (error instanceof AxiosError) {
    const data = error.response?.data as { error?: ErrorResponse };
    
    if (data?.error) {
      switch (data.error.code) {
        case 'AUTH_REQUIRED':
          return 'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™';
        case 'TOKEN_EXPIRED':
          return 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸ';
        case 'VALIDATION_ERROR':
          return data.error.message || 'å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
        case 'RATE_LIMIT':
          return 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
        default:
          return data.error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    }

    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼
    if (!error.response) {
      return 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    }
  }

  return 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
};
```

### 5. ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/ErrorBoundary.tsx:**
```typescript
import React, { Component, ErrorInfo, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
    
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    if (process.env.NODE_ENV === 'production') {
      // logErrorToService(error, errorInfo);
    }
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || (
        <div className="error-boundary">
          <h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
          <p>ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
          <button onClick={() => window.location.reload()}>
            ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [ ] ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå‹•ä½œã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã‚‹
- [ ] é©åˆ‡ãªHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒè¿”ã•ã‚Œã‚‹
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒã‚¦ãƒ³ãƒ€ãƒªãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

## ğŸ”§ æŠ€è¡“è¦ä»¶

- winstonï¼ˆãƒ­ã‚®ãƒ³ã‚°ï¼‰
- ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
- Express ã‚¨ãƒ©ãƒ¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
6æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P2-005: èªè¨¼APIçµ±åˆ

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
describe('Error Handling', () => {
  it('should handle validation errors', async () => {
    const response = await request(app)
      .post('/api/auth/register')
      .send({ email: 'invalid' });

    expect(response.status).toBe(400);
    expect(response.body.error.code).toBe('VALIDATION_ERROR');
  });

  it('should handle authentication errors', async () => {
    const response = await request(app)
      .get('/api/users/me');

    expect(response.status).toBe(401);
    expect(response.body.error.code).toBe('AUTH_REQUIRED');
  });
});
```

## ğŸ“Œ æ³¨æ„äº‹é …

- æœ¬ç•ªç’°å¢ƒã§ã¯è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’éš ã™
- ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãªæƒ…å ±ã‚’ãƒ­ã‚°ã«å«ã‚ãªã„
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`error-handling`, `logging`, `security`, `phase2`

## ğŸ“… ä½œæˆæ—¥
2025-09-08