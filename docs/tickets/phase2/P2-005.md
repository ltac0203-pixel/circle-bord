# ãƒã‚±ãƒƒãƒˆ P2-005: èªè¨¼APIçµ±åˆ

## ğŸ“‹ æ¦‚è¦
èªè¨¼é–¢é€£ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨çµ±åˆã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆAPI
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²API
- èªè¨¼çŠ¶æ…‹ç¢ºèªAPI
- ãƒ¡ãƒ¼ãƒ«èªè¨¼æ©Ÿèƒ½

## ğŸ“ è©³ç´°èª¬æ˜

### 1. èªè¨¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å®Ÿè£…

**src/controllers/AuthController.ts:**
```typescript
import { Request, Response } from 'express';
import { AuthService } from '../services/AuthService';
import { JWTService } from '../utils/jwt';
import { validate } from 'class-validator';

export class AuthController {
  constructor(private authService: AuthService) {}

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
   */
  async register(req: Request, res: Response): Promise<void> {
    try {
      const { email, password, name } = req.body;

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const errors = await this.authService.validateRegistration(email, password, name);
      if (errors.length > 0) {
        res.status(400).json({ errors });
        return;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
      const user = await this.authService.register(email, password, name);

      // ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
      const tokens = JWTService.generateTokenPair({
        userId: user.id,
        email: user.email
      });

      res.status(201).json({
        user: {
          id: user.id,
          email: user.email,
          name: user.name
        },
        ...tokens
      });
    } catch (error) {
      res.status(400).json({ 
        message: error.message 
      });
    }
  }

  /**
   * ãƒ­ã‚°ã‚¤ãƒ³
   */
  async login(req: Request, res: Response): Promise<void> {
    try {
      const { email, password } = req.body;

      const user = await this.authService.authenticate(email, password);

      if (!user) {
        res.status(401).json({ 
          message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' 
        });
        return;
      }

      // ãƒãƒ¼ãƒ æƒ…å ±ã‚’å«ã‚ã¦ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
      const userTeams = await this.authService.getUserTeams(user.id);
      const tokens = JWTService.generateTokenPair({
        userId: user.id,
        email: user.email,
        teamIds: userTeams.map(ut => ut.teamId)
      });

      res.json({
        user: {
          id: user.id,
          email: user.email,
          name: user.name,
          teams: userTeams
        },
        ...tokens
      });
    } catch (error) {
      res.status(500).json({ 
        message: 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' 
      });
    }
  }

  /**
   * ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
   */
  async me(req: Request, res: Response): Promise<void> {
    try {
      const userId = req.user!.id;
      const user = await this.authService.getUserWithTeams(userId);

      res.json(user);
    } catch (error) {
      res.status(500).json({ 
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ' 
      });
    }
  }

  /**
   * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª
   */
  async verifyEmail(req: Request, res: Response): Promise<void> {
    try {
      const { token } = req.params;
      
      await this.authService.verifyEmail(token);
      
      res.json({ 
        message: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ' 
      });
    } catch (error) {
      res.status(400).json({ 
        message: 'ãƒ¡ãƒ¼ãƒ«ç¢ºèªãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™' 
      });
    }
  }
}
```

### 2. èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…

**src/services/AuthService.ts:**
```typescript
import { User } from '../entities/User';
import { UserRepository } from '../repositories/UserRepository';
import { PasswordService } from './PasswordService';
import { EmailService } from './EmailService';
import * as crypto from 'crypto';

export class AuthService {
  constructor(
    private userRepository: UserRepository,
    private emailService: EmailService
  ) {}

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
   */
  async authenticate(email: string, password: string): Promise<User | null> {
    const user = await this.userRepository.findByEmail(email);
    
    if (!user) {
      return null;
    }

    const isValid = await PasswordService.verifyPassword(password, user.password);
    
    if (!isValid) {
      return null;
    }

    if (!user.isActive) {
      throw new Error('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
    }

    return user;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
   */
  async register(email: string, password: string, name: string): Promise<User> {
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    const existing = await this.userRepository.findByEmail(email);
    if (existing) {
      throw new Error('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯
    const validation = PasswordService.validatePasswordStrength(password);
    if (!validation.isValid) {
      throw new Error(validation.errors.join(', '));
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
    const hashedPassword = await PasswordService.hashPassword(password);
    const user = await this.userRepository.create({
      email,
      password: hashedPassword,
      name,
      isActive: false // ãƒ¡ãƒ¼ãƒ«ç¢ºèªã¾ã§ç„¡åŠ¹
    });

    // ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡
    const verificationToken = crypto.randomBytes(32).toString('hex');
    await this.emailService.sendVerificationEmail(email, verificationToken);

    return user;
  }

  /**
   * ç™»éŒ²ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   */
  async validateRegistration(
    email: string,
    password: string,
    name: string
  ): Promise<string[]> {
    const errors: string[] = [];

    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
      errors.push('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    const passwordValidation = PasswordService.validatePasswordStrength(password);
    if (!passwordValidation.isValid) {
      errors.push(...passwordValidation.errors);
    }

    if (!name || name.length < 2) {
      errors.push('åå‰ã¯2æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    }

    return errors;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ¼ãƒ æƒ…å ±å–å¾—
   */
  async getUserTeams(userId: string): Promise<any[]> {
    const user = await this.userRepository.findWithTeams(userId);
    return user?.userTeams || [];
  }

  /**
   * ãƒãƒ¼ãƒ æƒ…å ±ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
   */
  async getUserWithTeams(userId: string): Promise<any> {
    const user = await this.userRepository.findWithTeams(userId);
    
    if (!user) {
      throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    return {
      id: user.id,
      email: user.email,
      name: user.name,
      teams: user.userTeams.map(ut => ({
        id: ut.team.id,
        name: ut.team.name,
        role: ut.role
      }))
    };
  }

  /**
   * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºèª
   */
  async verifyEmail(token: string): Promise<void> {
    // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã¨æœ‰åŠ¹åŒ–å‡¦ç†
    // å®Ÿè£…çœç•¥
  }
}
```

### 3. èªè¨¼ãƒ«ãƒ¼ãƒˆè¨­å®š

**src/routes/auth.ts:**
```typescript
import { Router } from 'express';
import { AuthController } from '../controllers/AuthController';
import { AuthService } from '../services/AuthService';
import { authenticate } from '../middlewares/auth';
import { rateLimiter } from '../middlewares/rateLimiter';

const router = Router();

const authService = new AuthService(userRepository, emailService);
const authController = new AuthController(authService);

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ä»˜ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
router.post('/register', rateLimiter(5, 15), authController.register);
router.post('/login', rateLimiter(5, 15), authController.login);
router.post('/logout', authenticate, authController.logout);
router.post('/refresh', authController.refreshToken);

// èªè¨¼å¿…é ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
router.get('/me', authenticate, authController.me);
router.get('/verify/:token', authController.verifyEmail);

export default router;
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²APIãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ­ã‚°ã‚¤ãƒ³APIãŒå‹•ä½œã™ã‚‹
- [ ] ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ãç™ºè¡Œã•ã‚Œã‚‹
- [ ] èªè¨¼çŠ¶æ…‹ãŒç¢ºèªã§ãã‚‹
- [ ] ãƒ¡ãƒ¼ãƒ«ç¢ºèªæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå®Ÿè£…ã•ã‚Œã‚‹

## ğŸ”§ æŠ€è¡“è¦ä»¶

- Express.js
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
8æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P2-001: JWTèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
- P2-002: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
describe('Auth API', () => {
  it('should register new user', async () => {
    const response = await request(app)
      .post('/api/auth/register')
      .send({
        email: 'test@example.com',
        password: 'Test@1234',
        name: 'Test User'
      });

    expect(response.status).toBe(201);
    expect(response.body.user.email).toBe('test@example.com');
    expect(response.body.accessToken).toBeDefined();
  });
});
```

## ğŸ“Œ æ³¨æ„äº‹é …

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ãªã„
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã§ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã‚’é˜²ã
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§æƒ…å ±æ¼æ´©ã—ãªã„

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`api`, `auth`, `integration`, `phase2`

## ğŸ“… ä½œæˆæ—¥
2025-09-08