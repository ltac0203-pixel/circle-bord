# ãƒã‚±ãƒƒãƒˆ P4-003: React Queryçµ±åˆ

## ğŸ“‹ æ¦‚è¦
React Queryã‚’å°å…¥ã—ã€ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç®¡ç†ã€ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã€åŒæœŸã‚’æœ€é©åŒ–ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- React Queryè¨­å®š
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥å®Ÿè£…
- æ¥½è¦³çš„æ›´æ–°è¨­å®š

## ğŸ“ è©³ç´°èª¬æ˜

### 1. React Queryè¨­å®š

**src/App.tsx:**
```typescript
import { QueryClient, QueryClientProvider } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: (failureCount, error: any) => {
        if (error.status === 404) return false;
        if (error.status === 401) return false;
        return failureCount < 2;
      },
      staleTime: 5 * 60 * 1000, // 5åˆ†
      cacheTime: 10 * 60 * 1000, // 10åˆ†
    },
    mutations: {
      retry: false,
      onError: (error: any) => {
        if (error.response?.status === 401) {
          // èªè¨¼ã‚¨ãƒ©ãƒ¼å‡¦ç†
          queryClient.clear();
          window.location.href = '/signin';
        }
      }
    }
  }
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <Router>
          <Routes>
            {/* ãƒ«ãƒ¼ãƒˆå®šç¾© */}
          </Routes>
        </Router>
      </AuthProvider>
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

### 2. ã‚¯ã‚¨ãƒªã‚­ãƒ¼ç®¡ç†

**src/utils/queryKeys.ts:**
```typescript
export const queryKeys = {
  all: ['all'] as const,
  
  auth: {
    all: ['auth'] as const,
    me: () => ['auth', 'me'] as const,
  },
  
  teams: {
    all: ['teams'] as const,
    lists: () => ['teams', 'list'] as const,
    list: (filters?: TeamFilters) => ['teams', 'list', filters] as const,
    details: () => ['teams', 'details'] as const,
    detail: (id: number) => ['teams', 'details', id] as const,
    members: (id: number) => ['teams', 'members', id] as const,
  },
  
  games: {
    all: ['games'] as const,
    lists: () => ['games', 'list'] as const,
    list: (teamId?: number, filters?: GameFilters) => 
      ['games', 'list', teamId, filters] as const,
    detail: (id: number) => ['games', 'detail', id] as const,
  },
  
  matches: {
    all: ['matches'] as const,
    lists: () => ['matches', 'list'] as const,
    list: (teamId?: number) => ['matches', 'list', teamId] as const,
    detail: (id: number) => ['matches', 'detail', id] as const,
  },
  
  masterData: {
    sports: ['masterData', 'sports'] as const,
    locations: ['masterData', 'locations'] as const,
    prefectures: ['masterData', 'prefectures'] as const,
  }
};
```

### 3. ã‚¯ã‚¨ãƒªç„¡åŠ¹åŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼

**src/utils/queryInvalidation.ts:**
```typescript
import { QueryClient } from 'react-query';
import { queryKeys } from './queryKeys';

export class QueryInvalidator {
  constructor(private queryClient: QueryClient) {}

  // ãƒãƒ¼ãƒ é–¢é€£ã®ç„¡åŠ¹åŒ–
  invalidateTeam(teamId?: number) {
    if (teamId) {
      this.queryClient.invalidateQueries(queryKeys.teams.detail(teamId));
      this.queryClient.invalidateQueries(queryKeys.teams.members(teamId));
    } else {
      this.queryClient.invalidateQueries(queryKeys.teams.all);
    }
  }

  // ã‚²ãƒ¼ãƒ é–¢é€£ã®ç„¡åŠ¹åŒ–
  invalidateGames(teamId?: number) {
    if (teamId) {
      this.queryClient.invalidateQueries(queryKeys.games.list(teamId));
    } else {
      this.queryClient.invalidateQueries(queryKeys.games.all);
    }
  }

  // ãƒãƒƒãƒãƒ³ã‚°é–¢é€£ã®ç„¡åŠ¹åŒ–
  invalidateMatches() {
    this.queryClient.invalidateQueries(queryKeys.matches.all);
    // ãƒãƒƒãƒãƒ³ã‚°ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã‚²ãƒ¼ãƒ ã‚‚æ›´æ–°
    this.queryClient.invalidateQueries(queryKeys.games.all);
  }

  // å…¨ãƒ‡ãƒ¼ã‚¿ç„¡åŠ¹åŒ–
  invalidateAll() {
    this.queryClient.invalidateQueries();
  }
}
```

### 4. ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒƒãƒˆã‚¯ã‚¨ãƒªå®Ÿè£…

**src/hooks/useInfiniteGames.ts:**
```typescript
export const useInfiniteGames = (teamId: number, filters?: GameFilters) => {
  return useInfiniteQuery(
    queryKeys.games.list(teamId, filters),
    ({ pageParam = 1 }) => 
      gameService.getGames(teamId, { ...filters, page: pageParam }),
    {
      getNextPageParam: (lastPage, pages) => {
        if (lastPage.hasMore) {
          return pages.length + 1;
        }
        return undefined;
      },
      enabled: !!teamId,
      staleTime: 5 * 60 * 1000
    }
  );
};

// ä½¿ç”¨ä¾‹
const InfiniteGameList = () => {
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage
  } = useInfiniteGames(teamId);

  return (
    <>
      {data?.pages.map((page, i) => (
        <React.Fragment key={i}>
          {page.games.map(game => (
            <GameCard key={game.id} game={game} />
          ))}
        </React.Fragment>
      ))}
      
      {hasNextPage && (
        <button
          onClick={() => fetchNextPage()}
          disabled={isFetchingNextPage}
        >
          {isFetchingNextPage ? 'Loading...' : 'Load More'}
        </button>
      )}
    </>
  );
};
```

### 5. ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å…±é€šå‡¦ç†

**src/hooks/useMutationWithToast.ts:**
```typescript
export const useMutationWithToast = <TData, TVariables>(
  mutationFn: (variables: TVariables) => Promise<TData>,
  options?: {
    successMessage?: string;
    errorMessage?: string;
    onSuccess?: (data: TData) => void;
    onError?: (error: Error) => void;
  }
) => {
  return useMutation(mutationFn, {
    onSuccess: (data) => {
      if (options?.successMessage) {
        toast.success(options.successMessage);
      }
      options?.onSuccess?.(data);
    },
    onError: (error: Error) => {
      if (options?.errorMessage) {
        toast.error(options.errorMessage);
      } else {
        toast.error(error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
      options?.onError?.(error);
    }
  });
};
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] React QueryãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒçµ±ä¸€ã•ã‚Œã‚‹
- [ ] é–‹ç™ºãƒ„ãƒ¼ãƒ«ãŒåˆ©ç”¨å¯èƒ½
- [ ] ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒƒãƒˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ

## ğŸ”§ æŠ€è¡“è¦ä»¶

- React Query 3.39+
- TypeScriptå¯¾å¿œ
- DevToolsçµ±åˆ

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
10æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P4-002: ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ä½œæˆ

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
describe('React Query Integration', () => {
  it('should cache data properly', async () => {
    const wrapper = createQueryWrapper();
    
    const { result, rerender } = renderHook(
      () => useGames(1),
      { wrapper }
    );
    
    await waitFor(() => expect(result.current.isSuccess).toBe(true));
    
    const firstCallData = result.current.data;
    
    // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã‚‚APIã¯å‘¼ã°ã‚Œãªã„ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ï¼‰
    rerender();
    
    expect(result.current.data).toBe(firstCallData);
    expect(mockApi.getGames).toHaveBeenCalledTimes(1);
  });
});
```

## ğŸ“Œ æ³¨æ„äº‹é …

- éåº¦ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’é¿ã‘ã‚‹
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã«æ³¨æ„
- ã‚¨ãƒ©ãƒ¼å¢ƒç•Œã®å®Ÿè£…

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`react-query`, `cache`, `state-management`, `phase4`

## ğŸ“… ä½œæˆæ—¥
2025-09-08