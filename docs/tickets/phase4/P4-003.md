# チケット P4-003: React Query統合

## 📋 概要
React Queryを導入し、サーバー状態管理、キャッシング、同期を最適化する。

## 🎯 目標
- React Query設定
- グローバルエラーハンドリング
- キャッシュ戦略実装
- 楽観的更新設定

## 📝 詳細説明

### 1. React Query設定

**src/App.tsx:**
```typescript
import { QueryClient, QueryClientProvider } from 'react-query';
import { ReactQueryDevtools } from 'react-query/devtools';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: (failureCount, error: any) => {
        if (error.status === 404) return false;
        if (error.status === 401) return false;
        return failureCount < 2;
      },
      staleTime: 5 * 60 * 1000, // 5分
      cacheTime: 10 * 60 * 1000, // 10分
    },
    mutations: {
      retry: false,
      onError: (error: any) => {
        if (error.response?.status === 401) {
          // 認証エラー処理
          queryClient.clear();
          window.location.href = '/signin';
        }
      }
    }
  }
});

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <AuthProvider>
        <Router>
          <Routes>
            {/* ルート定義 */}
          </Routes>
        </Router>
      </AuthProvider>
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

### 2. クエリキー管理

**src/utils/queryKeys.ts:**
```typescript
export const queryKeys = {
  all: ['all'] as const,
  
  auth: {
    all: ['auth'] as const,
    me: () => ['auth', 'me'] as const,
  },
  
  teams: {
    all: ['teams'] as const,
    lists: () => ['teams', 'list'] as const,
    list: (filters?: TeamFilters) => ['teams', 'list', filters] as const,
    details: () => ['teams', 'details'] as const,
    detail: (id: number) => ['teams', 'details', id] as const,
    members: (id: number) => ['teams', 'members', id] as const,
  },
  
  games: {
    all: ['games'] as const,
    lists: () => ['games', 'list'] as const,
    list: (teamId?: number, filters?: GameFilters) => 
      ['games', 'list', teamId, filters] as const,
    detail: (id: number) => ['games', 'detail', id] as const,
  },
  
  matches: {
    all: ['matches'] as const,
    lists: () => ['matches', 'list'] as const,
    list: (teamId?: number) => ['matches', 'list', teamId] as const,
    detail: (id: number) => ['matches', 'detail', id] as const,
  },
  
  masterData: {
    sports: ['masterData', 'sports'] as const,
    locations: ['masterData', 'locations'] as const,
    prefectures: ['masterData', 'prefectures'] as const,
  }
};
```

### 3. クエリ無効化ヘルパー

**src/utils/queryInvalidation.ts:**
```typescript
import { QueryClient } from 'react-query';
import { queryKeys } from './queryKeys';

export class QueryInvalidator {
  constructor(private queryClient: QueryClient) {}

  // チーム関連の無効化
  invalidateTeam(teamId?: number) {
    if (teamId) {
      this.queryClient.invalidateQueries(queryKeys.teams.detail(teamId));
      this.queryClient.invalidateQueries(queryKeys.teams.members(teamId));
    } else {
      this.queryClient.invalidateQueries(queryKeys.teams.all);
    }
  }

  // ゲーム関連の無効化
  invalidateGames(teamId?: number) {
    if (teamId) {
      this.queryClient.invalidateQueries(queryKeys.games.list(teamId));
    } else {
      this.queryClient.invalidateQueries(queryKeys.games.all);
    }
  }

  // マッチング関連の無効化
  invalidateMatches() {
    this.queryClient.invalidateQueries(queryKeys.matches.all);
    // マッチングが変更されたらゲームも更新
    this.queryClient.invalidateQueries(queryKeys.games.all);
  }

  // 全データ無効化
  invalidateAll() {
    this.queryClient.invalidateQueries();
  }
}
```

### 4. インフィニットクエリ実装

**src/hooks/useInfiniteGames.ts:**
```typescript
export const useInfiniteGames = (teamId: number, filters?: GameFilters) => {
  return useInfiniteQuery(
    queryKeys.games.list(teamId, filters),
    ({ pageParam = 1 }) => 
      gameService.getGames(teamId, { ...filters, page: pageParam }),
    {
      getNextPageParam: (lastPage, pages) => {
        if (lastPage.hasMore) {
          return pages.length + 1;
        }
        return undefined;
      },
      enabled: !!teamId,
      staleTime: 5 * 60 * 1000
    }
  );
};

// 使用例
const InfiniteGameList = () => {
  const {
    data,
    fetchNextPage,
    hasNextPage,
    isFetchingNextPage
  } = useInfiniteGames(teamId);

  return (
    <>
      {data?.pages.map((page, i) => (
        <React.Fragment key={i}>
          {page.games.map(game => (
            <GameCard key={game.id} game={game} />
          ))}
        </React.Fragment>
      ))}
      
      {hasNextPage && (
        <button
          onClick={() => fetchNextPage()}
          disabled={isFetchingNextPage}
        >
          {isFetchingNextPage ? 'Loading...' : 'Load More'}
        </button>
      )}
    </>
  );
};
```

### 5. ミューテーション共通処理

**src/hooks/useMutationWithToast.ts:**
```typescript
export const useMutationWithToast = <TData, TVariables>(
  mutationFn: (variables: TVariables) => Promise<TData>,
  options?: {
    successMessage?: string;
    errorMessage?: string;
    onSuccess?: (data: TData) => void;
    onError?: (error: Error) => void;
  }
) => {
  return useMutation(mutationFn, {
    onSuccess: (data) => {
      if (options?.successMessage) {
        toast.success(options.successMessage);
      }
      options?.onSuccess?.(data);
    },
    onError: (error: Error) => {
      if (options?.errorMessage) {
        toast.error(options.errorMessage);
      } else {
        toast.error(error.message || 'エラーが発生しました');
      }
      options?.onError?.(error);
    }
  });
};
```

## ✅ 受け入れ条件

- [ ] React Queryが正しく設定される
- [ ] キャッシング戦略が機能する
- [ ] エラーハンドリングが統一される
- [ ] 開発ツールが利用可能
- [ ] インフィニットスクロール対応

## 🔧 技術要件

- React Query 3.39+
- TypeScript対応
- DevTools統合

## ⏱️ 見積もり時間
10時間

## 🔗 依存関係
- P4-002: カスタムフック作成

## 🧪 テスト方針

```typescript
describe('React Query Integration', () => {
  it('should cache data properly', async () => {
    const wrapper = createQueryWrapper();
    
    const { result, rerender } = renderHook(
      () => useGames(1),
      { wrapper }
    );
    
    await waitFor(() => expect(result.current.isSuccess).toBe(true));
    
    const firstCallData = result.current.data;
    
    // 再レンダリングしてもAPIは呼ばれない（キャッシュから取得）
    rerender();
    
    expect(result.current.data).toBe(firstCallData);
    expect(mockApi.getGames).toHaveBeenCalledTimes(1);
  });
});
```

## 📌 注意事項

- 過度なキャッシュを避ける
- メモリリークに注意
- エラー境界の実装

## 🏷️ ラベル
`react-query`, `cache`, `state-management`, `phase4`

## 📅 作成日
2025-09-08