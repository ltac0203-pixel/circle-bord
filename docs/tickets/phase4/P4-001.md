# チケット P4-001: Dashboard.tsxリファクタ

## 📋 概要
Dashboard.tsxをローカルストレージからAPI連携に完全移行し、リアルタイムデータ表示を実現する。

## 🎯 目標
- ローカルstate削除
- API連携実装
- リアルタイムデータ表示
- コンポーネント分割

## 📝 詳細説明

### 1. 新しいDashboard実装

**src/components/Dashboard.tsx:**
```typescript
import React, { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { useTeam } from '../contexts/TeamContext';
import { useGames } from '../hooks/useGames';
import { useMatches } from '../hooks/useMatches';
import { GameList } from './game/GameList';
import { GameForm } from './game/GameForm';
import { MatchList } from './match/MatchList';
import { TeamStatistics } from './team/TeamStatistics';
import { FilterPanel } from './common/FilterPanel';

export const Dashboard: React.FC = () => {
  const { user } = useAuth();
  const { currentTeam } = useTeam();
  const [activeTab, setActiveTab] = useState<'games' | 'matches' | 'stats'>('games');
  const [filters, setFilters] = useState<GameFilters>({
    status: 'open',
    sportId: null,
    date: null
  });

  const {
    data: games,
    isLoading: gamesLoading,
    error: gamesError,
    refetch: refetchGames
  } = useGames(currentTeam?.id, filters);

  const {
    data: matches,
    isLoading: matchesLoading,
    refetch: refetchMatches
  } = useMatches(currentTeam?.id);

  if (!currentTeam) {
    return (
      <div className="no-team-message">
        <h2>チームに所属していません</h2>
        <p>チームを作成するか、招待を受けてください。</p>
        <CreateTeamButton />
      </div>
    );
  }

  return (
    <div className="dashboard">
      <div className="dashboard-header">
        <h1>ダッシュボード</h1>
        <TeamSelector />
      </div>

      <div className="dashboard-tabs">
        <button
          className={`tab ${activeTab === 'games' ? 'active' : ''}`}
          onClick={() => setActiveTab('games')}
        >
          試合管理
        </button>
        <button
          className={`tab ${activeTab === 'matches' ? 'active' : ''}`}
          onClick={() => setActiveTab('matches')}
        >
          マッチング
        </button>
        <button
          className={`tab ${activeTab === 'stats' ? 'active' : ''}`}
          onClick={() => setActiveTab('stats')}
        >
          統計
        </button>
      </div>

      <div className="dashboard-content">
        {activeTab === 'games' && (
          <div className="games-section">
            <FilterPanel
              filters={filters}
              onFilterChange={setFilters}
            />
            
            <GameForm
              teamId={currentTeam.id}
              onGameCreated={refetchGames}
            />
            
            {gamesLoading ? (
              <LoadingSpinner />
            ) : gamesError ? (
              <ErrorMessage error={gamesError} />
            ) : (
              <GameList
                games={games || []}
                onUpdate={refetchGames}
              />
            )}
          </div>
        )}

        {activeTab === 'matches' && (
          <div className="matches-section">
            {matchesLoading ? (
              <LoadingSpinner />
            ) : (
              <MatchList
                matches={matches || []}
                onUpdate={refetchMatches}
              />
            )}
          </div>
        )}

        {activeTab === 'stats' && (
          <TeamStatistics teamId={currentTeam.id} />
        )}
      </div>
    </div>
  );
};
```

### 2. GameListコンポーネント分離

**src/components/game/GameList.tsx:**
```typescript
interface GameListProps {
  games: Game[];
  onUpdate: () => void;
}

export const GameList: React.FC<GameListProps> = ({ games, onUpdate }) => {
  const [selectedGame, setSelectedGame] = useState<Game | null>(null);

  const handleDelete = async (gameId: number) => {
    if (window.confirm('この試合を削除しますか？')) {
      try {
        await gameService.deleteGame(gameId);
        toast.success('試合を削除しました');
        onUpdate();
      } catch (error) {
        toast.error('削除に失敗しました');
      }
    }
  };

  const handleStatusChange = async (gameId: number, status: GameStatus) => {
    try {
      await gameService.updateGameStatus(gameId, status);
      toast.success('ステータスを更新しました');
      onUpdate();
    } catch (error) {
      toast.error('更新に失敗しました');
    }
  };

  if (games.length === 0) {
    return (
      <div className="empty-state">
        <p>試合がありません</p>
      </div>
    );
  }

  return (
    <div className="game-list">
      {games.map(game => (
        <GameCard
          key={game.id}
          game={game}
          onEdit={() => setSelectedGame(game)}
          onDelete={() => handleDelete(game.id)}
          onStatusChange={(status) => handleStatusChange(game.id, status)}
        />
      ))}

      {selectedGame && (
        <GameEditModal
          game={selectedGame}
          onClose={() => setSelectedGame(null)}
          onSave={onUpdate}
        />
      )}
    </div>
  );
};
```

### 3. GameFormコンポーネント

**src/components/game/GameForm.tsx:**
```typescript
interface GameFormProps {
  teamId: number;
  onGameCreated: () => void;
}

export const GameForm: React.FC<GameFormProps> = ({ teamId, onGameCreated }) => {
  const [isOpen, setIsOpen] = useState(false);
  const [formData, setFormData] = useState<CreateGameDto>({
    sportId: 0,
    locationId: 0,
    date: '',
    startTime: '',
    endTime: '',
    contact: '',
    description: '',
    maxParticipants: undefined
  });

  const { data: sports } = useSports();
  const { data: locations } = useLocations();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      await gameService.createGame(teamId, formData);
      toast.success('試合を作成しました');
      setIsOpen(false);
      resetForm();
      onGameCreated();
    } catch (error) {
      toast.error('試合の作成に失敗しました');
    }
  };

  const resetForm = () => {
    setFormData({
      sportId: 0,
      locationId: 0,
      date: '',
      startTime: '',
      endTime: '',
      contact: '',
      description: '',
      maxParticipants: undefined
    });
  };

  return (
    <>
      <button
        className="btn-primary"
        onClick={() => setIsOpen(true)}
      >
        新しい試合を作成
      </button>

      {isOpen && (
        <Modal onClose={() => setIsOpen(false)}>
          <form onSubmit={handleSubmit} className="game-form">
            <h3>試合作成</h3>
            
            <select
              value={formData.sportId}
              onChange={(e) => setFormData({
                ...formData,
                sportId: parseInt(e.target.value)
              })}
              required
            >
              <option value="">スポーツを選択</option>
              {sports?.map(sport => (
                <option key={sport.id} value={sport.id}>
                  {sport.name}
                </option>
              ))}
            </select>

            <select
              value={formData.locationId}
              onChange={(e) => setFormData({
                ...formData,
                locationId: parseInt(e.target.value)
              })}
              required
            >
              <option value="">場所を選択</option>
              {locations?.map(location => (
                <option key={location.id} value={location.id}>
                  {location.name}
                </option>
              ))}
            </select>

            <input
              type="date"
              value={formData.date}
              onChange={(e) => setFormData({
                ...formData,
                date: e.target.value
              })}
              required
            />

            <input
              type="time"
              value={formData.startTime}
              onChange={(e) => setFormData({
                ...formData,
                startTime: e.target.value
              })}
              required
            />

            <textarea
              placeholder="詳細説明"
              value={formData.description}
              onChange={(e) => setFormData({
                ...formData,
                description: e.target.value
              })}
            />

            <div className="form-actions">
              <button type="button" onClick={() => setIsOpen(false)}>
                キャンセル
              </button>
              <button type="submit">作成</button>
            </div>
          </form>
        </Modal>
      )}
    </>
  );
};
```

## ✅ 受け入れ条件

- [ ] ローカルストレージを使用しない
- [ ] APIからデータを取得・表示
- [ ] リアルタイム更新が機能する
- [ ] エラーハンドリングが適切
- [ ] ローディング状態が表示される
- [ ] コンポーネントが適切に分割される

## 🔧 技術要件

- React hooks
- API連携
- 状態管理
- エラーハンドリング

## ⏱️ 見積もり時間
12時間

## 🔗 依存関係
- P2-004: AuthContext完全リファクタ
- P3-004: チーム切り替え機能

## 🧪 テスト方針

```typescript
describe('Dashboard', () => {
  it('should load games from API', async () => {
    const { getByText } = render(<Dashboard />);
    
    await waitFor(() => {
      expect(getByText('試合管理')).toBeInTheDocument();
    });
  });

  it('should handle API errors gracefully', async () => {
    mockApi.getGames.mockRejectedValue(new Error('API Error'));
    
    const { getByText } = render(<Dashboard />);
    
    await waitFor(() => {
      expect(getByText(/エラーが発生しました/)).toBeInTheDocument();
    });
  });
});
```

## 📌 注意事項

- パフォーマンス最適化
- 不要な再レンダリング防止
- キャッシュ戦略

## 🏷️ ラベル
`refactor`, `dashboard`, `api-integration`, `phase4`

## 📅 作成日
2025-09-08