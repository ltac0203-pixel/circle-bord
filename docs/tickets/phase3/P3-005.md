# ãƒã‚±ãƒƒãƒˆ P3-005: ãƒãƒ¼ãƒ çµ±è¨ˆè¡¨ç¤º

## ğŸ“‹ æ¦‚è¦
ãƒãƒ¼ãƒ ã®æ´»å‹•çµ±è¨ˆï¼ˆè©¦åˆæ•°ã€å‹ç‡ã€ãƒ¡ãƒ³ãƒãƒ¼æ•°ç­‰ï¼‰ã‚’é›†è¨ˆãƒ»è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- çµ±è¨ˆãƒ‡ãƒ¼ã‚¿é›†è¨ˆAPI
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
- ã‚°ãƒ©ãƒ•ãƒ»ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
- æœŸé–“åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

## ğŸ“ è©³ç´°èª¬æ˜

### 1. çµ±è¨ˆã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…

**src/services/TeamStatisticsService.ts:**
```typescript
export class TeamStatisticsService {
  async getTeamStatistics(teamId: number, period?: StatsPeriod): Promise<TeamStats> {
    const dateRange = this.getDateRange(period);
    
    const [
      totalGames,
      completedGames,
      upcomingGames,
      totalMatches,
      wonMatches,
      memberCount,
      sportDistribution
    ] = await Promise.all([
      this.gameRepository.count({ where: { teamId } }),
      this.gameRepository.count({ 
        where: { teamId, status: GameStatus.COMPLETED } 
      }),
      this.gameRepository.count({ 
        where: { teamId, status: GameStatus.OPEN } 
      }),
      this.getMatchCount(teamId, dateRange),
      this.getWonMatchCount(teamId, dateRange),
      this.userTeamRepository.count({ where: { teamId } }),
      this.getSportDistribution(teamId)
    ]);

    return {
      games: {
        total: totalGames,
        completed: completedGames,
        upcoming: upcomingGames
      },
      matches: {
        total: totalMatches,
        won: wonMatches,
        winRate: totalMatches > 0 ? (wonMatches / totalMatches) * 100 : 0
      },
      members: memberCount,
      sportDistribution,
      period
    };
  }

  private async getSportDistribution(teamId: number): Promise<SportStats[]> {
    const result = await this.gameRepository
      .createQueryBuilder('game')
      .select('sport.name', 'sport')
      .addSelect('COUNT(*)', 'count')
      .leftJoin('game.sport', 'sport')
      .where('game.teamId = :teamId', { teamId })
      .groupBy('sport.id')
      .getRawMany();

    return result.map(r => ({
      sport: r.sport,
      count: parseInt(r.count),
      percentage: 0 // å¾Œã§è¨ˆç®—
    }));
  }
}
```

### 2. çµ±è¨ˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/team/TeamStatistics.tsx:**
```typescript
import { Line, Pie } from 'react-chartjs-2';

export const TeamStatistics: React.FC<Props> = ({ teamId }) => {
  const [stats, setStats] = useState<TeamStats | null>(null);
  const [period, setPeriod] = useState<StatsPeriod>('month');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadStatistics();
  }, [teamId, period]);

  const loadStatistics = async () => {
    setLoading(true);
    try {
      const data = await statisticsService.getTeamStatistics(teamId, period);
      setStats(data);
    } catch (error) {
      console.error('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <LoadingSpinner />;
  if (!stats) return <div>çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>;

  const sportChartData = {
    labels: stats.sportDistribution.map(s => s.sport),
    datasets: [{
      data: stats.sportDistribution.map(s => s.count),
      backgroundColor: [
        '#FF6384',
        '#36A2EB',
        '#FFCE56',
        '#4BC0C0',
        '#9966FF'
      ]
    }]
  };

  return (
    <div className="team-statistics">
      <div className="stats-header">
        <h3>ãƒãƒ¼ãƒ çµ±è¨ˆ</h3>
        <select value={period} onChange={(e) => setPeriod(e.target.value as StatsPeriod)}>
          <option value="week">ä»Šé€±</option>
          <option value="month">ä»Šæœˆ</option>
          <option value="year">ä»Šå¹´</option>
          <option value="all">å…¨æœŸé–“</option>
        </select>
      </div>

      <div className="stats-grid">
        <StatCard
          title="ç·è©¦åˆæ•°"
          value={stats.games.total}
          icon={<GameIcon />}
        />
        
        <StatCard
          title="å®Œäº†è©¦åˆ"
          value={stats.games.completed}
          icon={<CheckIcon />}
        />
        
        <StatCard
          title="äºˆå®šè©¦åˆ"
          value={stats.games.upcoming}
          icon={<CalendarIcon />}
        />
        
        <StatCard
          title="å‹ç‡"
          value={`${stats.matches.winRate.toFixed(1)}%`}
          subtitle={`${stats.matches.won}å‹ / ${stats.matches.total}è©¦åˆ`}
          icon={<TrophyIcon />}
        />
        
        <StatCard
          title="ãƒ¡ãƒ³ãƒãƒ¼æ•°"
          value={stats.members}
          icon={<UsersIcon />}
        />
      </div>

      <div className="stats-charts">
        <div className="chart-container">
          <h4>ã‚¹ãƒãƒ¼ãƒ„åˆ¥è©¦åˆæ•°</h4>
          <Pie data={sportChartData} />
        </div>
        
        <div className="chart-container">
          <h4>æœˆåˆ¥æ´»å‹•æ¨ç§»</h4>
          <MonthlyActivityChart teamId={teamId} />
        </div>
      </div>
    </div>
  );
};
```

### 3. çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/team/StatCard.tsx:**
```typescript
interface StatCardProps {
  title: string;
  value: string | number;
  subtitle?: string;
  icon?: React.ReactNode;
  trend?: {
    value: number;
    isPositive: boolean;
  };
}

export const StatCard: React.FC<StatCardProps> = ({
  title,
  value,
  subtitle,
  icon,
  trend
}) => {
  return (
    <div className="stat-card">
      <div className="stat-card-header">
        {icon && <div className="stat-icon">{icon}</div>}
        <h5>{title}</h5>
      </div>
      
      <div className="stat-value">{value}</div>
      
      {subtitle && (
        <div className="stat-subtitle">{subtitle}</div>
      )}
      
      {trend && (
        <div className={`stat-trend ${trend.isPositive ? 'positive' : 'negative'}`}>
          {trend.isPositive ? 'â†‘' : 'â†“'} {Math.abs(trend.value)}%
        </div>
      )}
    </div>
  );
};
```

### 4. ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©

```css
.team-statistics {
  padding: 20px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.stat-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-value {
  font-size: 2em;
  font-weight: bold;
  color: #333;
  margin: 10px 0;
}

.stats-charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 30px;
  margin-top: 30px;
}
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŒæ­£ç¢ºã«é›†è¨ˆã•ã‚Œã‚‹
- [ ] æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] ã‚°ãƒ©ãƒ•ãŒé©åˆ‡ã«è¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã•ã‚Œã‚‹
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ

## ğŸ”§ æŠ€è¡“è¦ä»¶

- é›†è¨ˆã‚¯ã‚¨ãƒªæœ€é©åŒ–
- Chart.js
- ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
4æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P3-001: ãƒãƒ¼ãƒ CRUDæ©Ÿèƒ½å®Ÿè£…

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
describe('Team Statistics', () => {
  it('should calculate win rate correctly', async () => {
    const stats = await service.getTeamStatistics(teamId);
    expect(stats.matches.winRate).toBe((2 / 5) * 100);
  });
});
```

## ğŸ“Œ æ³¨æ„äº‹é …

- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- ã‚°ãƒ©ãƒ•ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é¸å®š

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`statistics`, `dashboard`, `visualization`, `phase3`

## ğŸ“… ä½œæˆæ—¥
2025-09-08