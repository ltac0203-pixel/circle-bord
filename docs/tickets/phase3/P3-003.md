# チケット P3-003: 権限管理システム

## 📋 概要
チーム内の役割（管理者、キャプテン、メンバー）に応じた権限管理システムを実装する。

## 🎯 目標
- 役割ベースのアクセス制御
- 権限チェックミドルウェア
- 権限に応じたUI表示制御
- 権限変更機能

## 📝 詳細説明

### 1. 権限定義

**src/utils/permissions.ts:**
```typescript
export enum Permission {
  // チーム管理
  TEAM_UPDATE = 'team:update',
  TEAM_DELETE = 'team:delete',
  
  // メンバー管理
  MEMBER_INVITE = 'member:invite',
  MEMBER_REMOVE = 'member:remove',
  MEMBER_UPDATE_ROLE = 'member:update_role',
  
  // 試合管理
  GAME_CREATE = 'game:create',
  GAME_UPDATE = 'game:update',
  GAME_DELETE = 'game:delete',
  
  // マッチング
  MATCH_CREATE = 'match:create',
  MATCH_APPROVE = 'match:approve'
}

export const rolePermissions: Record<TeamRole, Permission[]> = {
  [TeamRole.ADMIN]: [
    Permission.TEAM_UPDATE,
    Permission.TEAM_DELETE,
    Permission.MEMBER_INVITE,
    Permission.MEMBER_REMOVE,
    Permission.MEMBER_UPDATE_ROLE,
    Permission.GAME_CREATE,
    Permission.GAME_UPDATE,
    Permission.GAME_DELETE,
    Permission.MATCH_CREATE,
    Permission.MATCH_APPROVE
  ],
  [TeamRole.CAPTAIN]: [
    Permission.MEMBER_INVITE,
    Permission.GAME_CREATE,
    Permission.GAME_UPDATE,
    Permission.GAME_DELETE,
    Permission.MATCH_CREATE,
    Permission.MATCH_APPROVE
  ],
  [TeamRole.MEMBER]: [
    Permission.GAME_CREATE
  ]
};

export const hasPermission = (
  role: TeamRole,
  permission: Permission
): boolean => {
  return rolePermissions[role].includes(permission);
};
```

### 2. 権限チェックミドルウェア

**src/middlewares/permission.ts:**
```typescript
export const requirePermission = (permission: Permission) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const userId = req.user?.id;
    const teamId = parseInt(req.params.teamId || req.body.teamId);

    if (!userId || !teamId) {
      return res.status(400).json({ error: '必要な情報が不足しています' });
    }

    const membership = await userTeamRepository.findOne({
      where: { userId, teamId }
    });

    if (!membership) {
      return res.status(403).json({ error: 'チームメンバーではありません' });
    }

    if (!hasPermission(membership.role, permission)) {
      return res.status(403).json({ error: '権限がありません' });
    }

    req.teamMembership = membership;
    next();
  };
};
```

### 3. フロントエンド権限管理フック

**src/hooks/usePermission.ts:**
```typescript
export const usePermission = (teamId: number) => {
  const { user } = useAuth();
  
  const membership = useMemo(() => {
    return user?.teams.find(t => t.id === teamId);
  }, [user, teamId]);

  const can = useCallback((permission: Permission): boolean => {
    if (!membership) return false;
    return hasPermission(membership.role, permission);
  }, [membership]);

  return { 
    role: membership?.role,
    can,
    isAdmin: membership?.role === TeamRole.ADMIN,
    isCaptain: membership?.role === TeamRole.CAPTAIN,
    isMember: membership?.role === TeamRole.MEMBER
  };
};
```

### 4. 権限付きコンポーネント

**src/components/common/PermissionGate.tsx:**
```typescript
interface PermissionGateProps {
  teamId: number;
  permission?: Permission;
  role?: TeamRole;
  fallback?: React.ReactNode;
  children: React.ReactNode;
}

export const PermissionGate: React.FC<PermissionGateProps> = ({
  teamId,
  permission,
  role,
  fallback = null,
  children
}) => {
  const { can, role: userRole } = usePermission(teamId);

  const hasAccess = useMemo(() => {
    if (permission) {
      return can(permission);
    }
    if (role) {
      return userRole === role || 
        (role === TeamRole.MEMBER && userRole) ||
        (role === TeamRole.CAPTAIN && userRole === TeamRole.ADMIN);
    }
    return true;
  }, [permission, role, can, userRole]);

  return hasAccess ? <>{children}</> : <>{fallback}</>;
};

// 使用例
<PermissionGate teamId={team.id} permission={Permission.MEMBER_INVITE}>
  <button onClick={handleInvite}>メンバーを招待</button>
</PermissionGate>
```

## ✅ 受け入れ条件

- [ ] 役割に応じた権限が設定される
- [ ] 権限チェックが機能する
- [ ] UIが権限に応じて表示制御される
- [ ] 権限変更が適切に処理される

## 🔧 技術要件

- 役割ベースアクセス制御（RBAC）
- ミドルウェア実装
- React権限管理

## ⏱️ 見積もり時間
6時間

## 🔗 依存関係
- P3-001: チームCRUD機能実装

## 🧪 テスト方針

```typescript
describe('Permission System', () => {
  it('should allow admin all permissions', () => {
    expect(hasPermission(TeamRole.ADMIN, Permission.TEAM_DELETE)).toBe(true);
  });

  it('should restrict member permissions', () => {
    expect(hasPermission(TeamRole.MEMBER, Permission.TEAM_DELETE)).toBe(false);
    expect(hasPermission(TeamRole.MEMBER, Permission.GAME_CREATE)).toBe(true);
  });
});
```

## 📌 注意事項

- 権限昇格攻撃を防ぐ
- 最小権限の原則を適用
- 権限変更の監査ログ

## 🏷️ ラベル
`permission`, `rbac`, `security`, `phase3`

## 📅 作成日
2025-09-08