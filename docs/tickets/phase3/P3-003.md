# ãƒã‚±ãƒƒãƒˆ P3-003: æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“‹ æ¦‚è¦
ãƒãƒ¼ãƒ å†…ã®å½¹å‰²ï¼ˆç®¡ç†è€…ã€ã‚­ãƒ£ãƒ—ãƒ†ãƒ³ã€ãƒ¡ãƒ³ãƒãƒ¼ï¼‰ã«å¿œã˜ãŸæ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- å½¹å‰²ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- æ¨©é™ã«å¿œã˜ãŸUIè¡¨ç¤ºåˆ¶å¾¡
- æ¨©é™å¤‰æ›´æ©Ÿèƒ½

## ğŸ“ è©³ç´°èª¬æ˜

### 1. æ¨©é™å®šç¾©

**src/utils/permissions.ts:**
```typescript
export enum Permission {
  // ãƒãƒ¼ãƒ ç®¡ç†
  TEAM_UPDATE = 'team:update',
  TEAM_DELETE = 'team:delete',
  
  // ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
  MEMBER_INVITE = 'member:invite',
  MEMBER_REMOVE = 'member:remove',
  MEMBER_UPDATE_ROLE = 'member:update_role',
  
  // è©¦åˆç®¡ç†
  GAME_CREATE = 'game:create',
  GAME_UPDATE = 'game:update',
  GAME_DELETE = 'game:delete',
  
  // ãƒãƒƒãƒãƒ³ã‚°
  MATCH_CREATE = 'match:create',
  MATCH_APPROVE = 'match:approve'
}

export const rolePermissions: Record<TeamRole, Permission[]> = {
  [TeamRole.ADMIN]: [
    Permission.TEAM_UPDATE,
    Permission.TEAM_DELETE,
    Permission.MEMBER_INVITE,
    Permission.MEMBER_REMOVE,
    Permission.MEMBER_UPDATE_ROLE,
    Permission.GAME_CREATE,
    Permission.GAME_UPDATE,
    Permission.GAME_DELETE,
    Permission.MATCH_CREATE,
    Permission.MATCH_APPROVE
  ],
  [TeamRole.CAPTAIN]: [
    Permission.MEMBER_INVITE,
    Permission.GAME_CREATE,
    Permission.GAME_UPDATE,
    Permission.GAME_DELETE,
    Permission.MATCH_CREATE,
    Permission.MATCH_APPROVE
  ],
  [TeamRole.MEMBER]: [
    Permission.GAME_CREATE
  ]
};

export const hasPermission = (
  role: TeamRole,
  permission: Permission
): boolean => {
  return rolePermissions[role].includes(permission);
};
```

### 2. æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

**src/middlewares/permission.ts:**
```typescript
export const requirePermission = (permission: Permission) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    const userId = req.user?.id;
    const teamId = parseInt(req.params.teamId || req.body.teamId);

    if (!userId || !teamId) {
      return res.status(400).json({ error: 'å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™' });
    }

    const membership = await userTeamRepository.findOne({
      where: { userId, teamId }
    });

    if (!membership) {
      return res.status(403).json({ error: 'ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“' });
    }

    if (!hasPermission(membership.role, permission)) {
      return res.status(403).json({ error: 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“' });
    }

    req.teamMembership = membership;
    next();
  };
};
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ¨©é™ç®¡ç†ãƒ•ãƒƒã‚¯

**src/hooks/usePermission.ts:**
```typescript
export const usePermission = (teamId: number) => {
  const { user } = useAuth();
  
  const membership = useMemo(() => {
    return user?.teams.find(t => t.id === teamId);
  }, [user, teamId]);

  const can = useCallback((permission: Permission): boolean => {
    if (!membership) return false;
    return hasPermission(membership.role, permission);
  }, [membership]);

  return { 
    role: membership?.role,
    can,
    isAdmin: membership?.role === TeamRole.ADMIN,
    isCaptain: membership?.role === TeamRole.CAPTAIN,
    isMember: membership?.role === TeamRole.MEMBER
  };
};
```

### 4. æ¨©é™ä»˜ãã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/common/PermissionGate.tsx:**
```typescript
interface PermissionGateProps {
  teamId: number;
  permission?: Permission;
  role?: TeamRole;
  fallback?: React.ReactNode;
  children: React.ReactNode;
}

export const PermissionGate: React.FC<PermissionGateProps> = ({
  teamId,
  permission,
  role,
  fallback = null,
  children
}) => {
  const { can, role: userRole } = usePermission(teamId);

  const hasAccess = useMemo(() => {
    if (permission) {
      return can(permission);
    }
    if (role) {
      return userRole === role || 
        (role === TeamRole.MEMBER && userRole) ||
        (role === TeamRole.CAPTAIN && userRole === TeamRole.ADMIN);
    }
    return true;
  }, [permission, role, can, userRole]);

  return hasAccess ? <>{children}</> : <>{fallback}</>;
};

// ä½¿ç”¨ä¾‹
<PermissionGate teamId={team.id} permission={Permission.MEMBER_INVITE}>
  <button onClick={handleInvite}>ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</button>
</PermissionGate>
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] å½¹å‰²ã«å¿œã˜ãŸæ¨©é™ãŒè¨­å®šã•ã‚Œã‚‹
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] UIãŒæ¨©é™ã«å¿œã˜ã¦è¡¨ç¤ºåˆ¶å¾¡ã•ã‚Œã‚‹
- [ ] æ¨©é™å¤‰æ›´ãŒé©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹

## ğŸ”§ æŠ€è¡“è¦ä»¶

- å½¹å‰²ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼ˆRBACï¼‰
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…
- Reactæ¨©é™ç®¡ç†

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
6æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P3-001: ãƒãƒ¼ãƒ CRUDæ©Ÿèƒ½å®Ÿè£…

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
describe('Permission System', () => {
  it('should allow admin all permissions', () => {
    expect(hasPermission(TeamRole.ADMIN, Permission.TEAM_DELETE)).toBe(true);
  });

  it('should restrict member permissions', () => {
    expect(hasPermission(TeamRole.MEMBER, Permission.TEAM_DELETE)).toBe(false);
    expect(hasPermission(TeamRole.MEMBER, Permission.GAME_CREATE)).toBe(true);
  });
});
```

## ğŸ“Œ æ³¨æ„äº‹é …

- æ¨©é™æ˜‡æ ¼æ”»æ’ƒã‚’é˜²ã
- æœ€å°æ¨©é™ã®åŸå‰‡ã‚’é©ç”¨
- æ¨©é™å¤‰æ›´ã®ç›£æŸ»ãƒ­ã‚°

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`permission`, `rbac`, `security`, `phase3`

## ğŸ“… ä½œæˆæ—¥
2025-09-08