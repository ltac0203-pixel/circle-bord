# チケット P3-002: メンバー招待システム

## 📋 概要
チームへのメンバー招待機能を実装し、メール招待とリンク共有による参加を可能にする。

## 🎯 目標
- 招待トークン生成
- メール招待機能
- 招待リンクによる参加
- 招待承認フロー

## 📝 詳細説明

### 1. 招待Entity

**src/entities/TeamInvitation.ts:**
```typescript
@Entity('team_invitations')
export class TeamInvitation {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  teamId: number;

  @Column()
  invitedEmail: string;

  @Column({ unique: true })
  token: string;

  @Column()
  invitedById: string;

  @Column()
  role: TeamRole;

  @Column()
  expiresAt: Date;

  @Column({ default: false })
  accepted: boolean;

  @CreateDateColumn()
  createdAt: Date;
}
```

### 2. 招待サービス

**src/services/InvitationService.ts:**
```typescript
export class InvitationService {
  async inviteMember(
    teamId: number,
    inviterUserId: string,
    email: string,
    role: TeamRole = TeamRole.MEMBER
  ): Promise<void> {
    // 権限チェック
    await this.checkInvitePermission(teamId, inviterUserId);

    // 招待トークン生成
    const token = crypto.randomBytes(32).toString('hex');
    
    const invitation = await this.invitationRepository.create({
      teamId,
      invitedEmail: email,
      token,
      invitedById: inviterUserId,
      role,
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7日間有効
    });

    // 招待メール送信
    await this.emailService.sendTeamInvitation(email, {
      teamName: team.name,
      inviterName: inviter.name,
      inviteLink: `${process.env.FRONTEND_URL}/invite/${token}`
    });
  }

  async acceptInvitation(token: string, userId: string): Promise<void> {
    const invitation = await this.invitationRepository.findOne({
      where: { token, accepted: false }
    });

    if (!invitation || invitation.expiresAt < new Date()) {
      throw new Error('無効または期限切れの招待です');
    }

    // チームメンバーに追加
    await this.userTeamRepository.save({
      userId,
      teamId: invitation.teamId,
      role: invitation.role
    });

    // 招待を承認済みに更新
    invitation.accepted = true;
    await this.invitationRepository.save(invitation);
  }
}
```

### 3. 招待フォームコンポーネント

**src/components/team/MemberInviteForm.tsx:**
```typescript
export const MemberInviteForm: React.FC<Props> = ({ teamId, onInvited }) => {
  const [email, setEmail] = useState('');
  const [role, setRole] = useState<TeamRole>(TeamRole.MEMBER);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    try {
      await teamService.inviteMember(teamId, email, role);
      toast.success('招待メールを送信しました');
      setEmail('');
      onInvited();
    } catch (error) {
      toast.error('招待の送信に失敗しました');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="メールアドレス"
        required
      />
      
      <select value={role} onChange={(e) => setRole(e.target.value as TeamRole)}>
        <option value={TeamRole.MEMBER}>メンバー</option>
        <option value={TeamRole.CAPTAIN}>キャプテン</option>
        <option value={TeamRole.ADMIN}>管理者</option>
      </select>

      <button type="submit" disabled={isSubmitting}>
        招待を送信
      </button>
    </form>
  );
};
```

## ✅ 受け入れ条件

- [ ] メール招待が送信される
- [ ] 招待リンクから参加できる
- [ ] 招待に有効期限がある
- [ ] 権限を指定して招待できる
- [ ] 重複招待を防ぐ

## 🔧 技術要件

- メール送信
- トークン管理
- 有効期限処理

## ⏱️ 見積もり時間
6時間

## 🔗 依存関係
- P3-001: チームCRUD機能実装

## 🏷️ ラベル
`team`, `invitation`, `email`, `phase3`

## 📅 作成日
2025-09-08