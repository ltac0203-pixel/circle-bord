# ãƒã‚±ãƒƒãƒˆ P3-002: ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ã‚·ã‚¹ãƒ†ãƒ 

## ğŸ“‹ æ¦‚è¦
ãƒãƒ¼ãƒ ã¸ã®ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãƒ¡ãƒ¼ãƒ«æ‹›å¾…ã¨ãƒªãƒ³ã‚¯å…±æœ‰ã«ã‚ˆã‚‹å‚åŠ ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
- ãƒ¡ãƒ¼ãƒ«æ‹›å¾…æ©Ÿèƒ½
- æ‹›å¾…ãƒªãƒ³ã‚¯ã«ã‚ˆã‚‹å‚åŠ 
- æ‹›å¾…æ‰¿èªãƒ•ãƒ­ãƒ¼

## ğŸ“ è©³ç´°èª¬æ˜

### 1. æ‹›å¾…Entity

**src/entities/TeamInvitation.ts:**
```typescript
@Entity('team_invitations')
export class TeamInvitation {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  teamId: number;

  @Column()
  invitedEmail: string;

  @Column({ unique: true })
  token: string;

  @Column()
  invitedById: string;

  @Column()
  role: TeamRole;

  @Column()
  expiresAt: Date;

  @Column({ default: false })
  accepted: boolean;

  @CreateDateColumn()
  createdAt: Date;
}
```

### 2. æ‹›å¾…ã‚µãƒ¼ãƒ“ã‚¹

**src/services/InvitationService.ts:**
```typescript
export class InvitationService {
  async inviteMember(
    teamId: number,
    inviterUserId: string,
    email: string,
    role: TeamRole = TeamRole.MEMBER
  ): Promise<void> {
    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    await this.checkInvitePermission(teamId, inviterUserId);

    // æ‹›å¾…ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    const token = crypto.randomBytes(32).toString('hex');
    
    const invitation = await this.invitationRepository.create({
      teamId,
      invitedEmail: email,
      token,
      invitedById: inviterUserId,
      role,
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7æ—¥é–“æœ‰åŠ¹
    });

    // æ‹›å¾…ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    await this.emailService.sendTeamInvitation(email, {
      teamName: team.name,
      inviterName: inviter.name,
      inviteLink: `${process.env.FRONTEND_URL}/invite/${token}`
    });
  }

  async acceptInvitation(token: string, userId: string): Promise<void> {
    const invitation = await this.invitationRepository.findOne({
      where: { token, accepted: false }
    });

    if (!invitation || invitation.expiresAt < new Date()) {
      throw new Error('ç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®æ‹›å¾…ã§ã™');
    }

    // ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã«è¿½åŠ 
    await this.userTeamRepository.save({
      userId,
      teamId: invitation.teamId,
      role: invitation.role
    });

    // æ‹›å¾…ã‚’æ‰¿èªæ¸ˆã¿ã«æ›´æ–°
    invitation.accepted = true;
    await this.invitationRepository.save(invitation);
  }
}
```

### 3. æ‹›å¾…ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/team/MemberInviteForm.tsx:**
```typescript
export const MemberInviteForm: React.FC<Props> = ({ teamId, onInvited }) => {
  const [email, setEmail] = useState('');
  const [role, setRole] = useState<TeamRole>(TeamRole.MEMBER);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    try {
      await teamService.inviteMember(teamId, email, role);
      toast.success('æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
      setEmail('');
      onInvited();
    } catch (error) {
      toast.error('æ‹›å¾…ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
        required
      />
      
      <select value={role} onChange={(e) => setRole(e.target.value as TeamRole)}>
        <option value={TeamRole.MEMBER}>ãƒ¡ãƒ³ãƒãƒ¼</option>
        <option value={TeamRole.CAPTAIN}>ã‚­ãƒ£ãƒ—ãƒ†ãƒ³</option>
        <option value={TeamRole.ADMIN}>ç®¡ç†è€…</option>
      </select>

      <button type="submit" disabled={isSubmitting}>
        æ‹›å¾…ã‚’é€ä¿¡
      </button>
    </form>
  );
};
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ãƒ¡ãƒ¼ãƒ«æ‹›å¾…ãŒé€ä¿¡ã•ã‚Œã‚‹
- [ ] æ‹›å¾…ãƒªãƒ³ã‚¯ã‹ã‚‰å‚åŠ ã§ãã‚‹
- [ ] æ‹›å¾…ã«æœ‰åŠ¹æœŸé™ãŒã‚ã‚‹
- [ ] æ¨©é™ã‚’æŒ‡å®šã—ã¦æ‹›å¾…ã§ãã‚‹
- [ ] é‡è¤‡æ‹›å¾…ã‚’é˜²ã

## ğŸ”§ æŠ€è¡“è¦ä»¶

- ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
- æœ‰åŠ¹æœŸé™å‡¦ç†

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
6æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P3-001: ãƒãƒ¼ãƒ CRUDæ©Ÿèƒ½å®Ÿè£…

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`team`, `invitation`, `email`, `phase3`

## ğŸ“… ä½œæˆæ—¥
2025-09-08