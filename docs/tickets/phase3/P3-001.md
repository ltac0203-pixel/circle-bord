# ãƒã‚±ãƒƒãƒˆ P3-001: ãƒãƒ¼ãƒ CRUDæ©Ÿèƒ½å®Ÿè£…

## ğŸ“‹ æ¦‚è¦
ãƒãƒ¼ãƒ ã®ä½œæˆãƒ»èª­ã¿å–ã‚Šãƒ»æ›´æ–°ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å®Ÿè£…ã™ã‚‹ã€‚

## ğŸ¯ ç›®æ¨™
- ãƒãƒ¼ãƒ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
- ãƒãƒ¼ãƒ ç®¡ç†ç”»é¢ã®ä½œæˆ
- ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†
- æ¨©é™ãƒ™ãƒ¼ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

## ğŸ“ è©³ç´°èª¬æ˜

### 1. ãƒãƒ¼ãƒ ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…

**src/services/TeamService.ts:**
```typescript
import { Team } from '../entities/Team';
import { UserTeam, TeamRole } from '../entities/UserTeam';
import { TeamRepository } from '../repositories/TeamRepository';

export class TeamService {
  constructor(
    private teamRepository: TeamRepository,
    private userTeamRepository: Repository<UserTeam>
  ) {}

  async createTeam(userId: string, data: CreateTeamDto): Promise<Team> {
    // ãƒãƒ¼ãƒ ä½œæˆ
    const team = await this.teamRepository.create({
      ...data,
      createdById: userId
    });

    // ä½œæˆè€…ã‚’ç®¡ç†è€…ã¨ã—ã¦è¿½åŠ 
    await this.userTeamRepository.save({
      userId,
      teamId: team.id,
      role: TeamRole.ADMIN
    });

    return team;
  }

  async updateTeam(teamId: number, userId: string, data: UpdateTeamDto): Promise<Team> {
    // æ¨©é™ãƒã‚§ãƒƒã‚¯
    await this.checkPermission(teamId, userId, [TeamRole.ADMIN]);
    
    return this.teamRepository.update(teamId, data);
  }

  async deleteTeam(teamId: number, userId: string): Promise<void> {
    await this.checkPermission(teamId, userId, [TeamRole.ADMIN]);
    await this.teamRepository.delete(teamId);
  }

  async getTeamMembers(teamId: number): Promise<UserTeam[]> {
    return this.userTeamRepository.find({
      where: { teamId },
      relations: ['user'],
      order: { role: 'ASC' }
    });
  }

  private async checkPermission(
    teamId: number,
    userId: string,
    allowedRoles: TeamRole[]
  ): Promise<void> {
    const membership = await this.userTeamRepository.findOne({
      where: { teamId, userId }
    });

    if (!membership || !allowedRoles.includes(membership.role)) {
      throw new ForbiddenError('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
    }
  }
}
```

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒãƒ¼ãƒ ç®¡ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/team/TeamManagement.tsx:**
```typescript
import React, { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';
import { teamService } from '../../services/teamService';

export const TeamManagement: React.FC = () => {
  const { user } = useAuth();
  const [teams, setTeams] = useState<Team[]>([]);
  const [selectedTeam, setSelectedTeam] = useState<Team | null>(null);
  const [isCreating, setIsCreating] = useState(false);

  useEffect(() => {
    if (user) {
      loadTeams();
    }
  }, [user]);

  const loadTeams = async () => {
    try {
      const userTeams = await teamService.getUserTeams();
      setTeams(userTeams);
    } catch (error) {
      console.error('ãƒãƒ¼ãƒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
    }
  };

  const handleCreateTeam = async (data: CreateTeamData) => {
    try {
      const newTeam = await teamService.createTeam(data);
      setTeams([...teams, newTeam]);
      setIsCreating(false);
    } catch (error) {
      console.error('ãƒãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
    }
  };

  return (
    <div className="team-management">
      <h2>ãƒãƒ¼ãƒ ç®¡ç†</h2>
      
      <div className="team-list">
        <h3>æ‰€å±ãƒãƒ¼ãƒ </h3>
        {teams.map(team => (
          <TeamCard
            key={team.id}
            team={team}
            onClick={() => setSelectedTeam(team)}
          />
        ))}
        
        <button onClick={() => setIsCreating(true)}>
          æ–°ã—ã„ãƒãƒ¼ãƒ ã‚’ä½œæˆ
        </button>
      </div>

      {isCreating && (
        <TeamCreationModal
          onSubmit={handleCreateTeam}
          onClose={() => setIsCreating(false)}
        />
      )}

      {selectedTeam && (
        <TeamDetail
          team={selectedTeam}
          onUpdate={loadTeams}
          onClose={() => setSelectedTeam(null)}
        />
      )}
    </div>
  );
};
```

### 3. ãƒãƒ¼ãƒ è©³ç´°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**src/components/team/TeamDetail.tsx:**
```typescript
export const TeamDetail: React.FC<TeamDetailProps> = ({ team, onUpdate }) => {
  const [members, setMembers] = useState<TeamMember[]>([]);
  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    loadMembers();
  }, [team]);

  const loadMembers = async () => {
    const teamMembers = await teamService.getTeamMembers(team.id);
    setMembers(teamMembers);
  };

  const handleUpdateRole = async (userId: string, newRole: TeamRole) => {
    await teamService.updateMemberRole(team.id, userId, newRole);
    loadMembers();
  };

  return (
    <div className="team-detail">
      <h3>{team.name}</h3>
      
      <div className="team-info">
        <p>å¤§å­¦: {team.university}</p>
        <p>é€£çµ¡å…ˆ: {team.contactEmail}</p>
        <p>èª¬æ˜: {team.description}</p>
      </div>

      <div className="team-members">
        <h4>ãƒ¡ãƒ³ãƒãƒ¼ ({members.length})</h4>
        <table>
          <thead>
            <tr>
              <th>åå‰</th>
              <th>ãƒ¡ãƒ¼ãƒ«</th>
              <th>å½¹å‰²</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {members.map(member => (
              <tr key={member.userId}>
                <td>{member.user.name}</td>
                <td>{member.user.email}</td>
                <td>
                  <RoleSelector
                    value={member.role}
                    onChange={(role) => handleUpdateRole(member.userId, role)}
                    disabled={!canEditRole(currentUserRole, member.role)}
                  />
                </td>
                <td>
                  <button onClick={() => handleRemoveMember(member.userId)}>
                    å‰Šé™¤
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};
```

## âœ… å—ã‘å…¥ã‚Œæ¡ä»¶

- [ ] ãƒãƒ¼ãƒ ä½œæˆæ©Ÿèƒ½ãŒå‹•ä½œã™ã‚‹
- [ ] ãƒãƒ¼ãƒ æƒ…å ±ã®ç·¨é›†ãŒå¯èƒ½
- [ ] ãƒãƒ¼ãƒ å‰Šé™¤ãŒç®¡ç†è€…ã®ã¿å¯èƒ½
- [ ] ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] æ¨©é™ã«å¿œã˜ãŸæ“ä½œåˆ¶é™ãŒæ©Ÿèƒ½ã™ã‚‹

## ğŸ”§ æŠ€è¡“è¦ä»¶

- ãƒãƒ¼ãƒ CRUD API
- æ¨©é™ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
- React ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

## â±ï¸ è¦‹ç©ã‚‚ã‚Šæ™‚é–“
8æ™‚é–“

## ğŸ”— ä¾å­˜é–¢ä¿‚
- P1-003: Entityå®šç¾©å®Ÿè£…
- P2-001: JWTèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢å®Ÿè£…

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹é‡

```typescript
describe('TeamService', () => {
  it('should create team with creator as admin', async () => {
    const team = await teamService.createTeam(userId, {
      name: 'Test Team',
      university: 'Test University'
    });

    const members = await teamService.getTeamMembers(team.id);
    expect(members[0].role).toBe(TeamRole.ADMIN);
  });
});
```

## ğŸ“Œ æ³¨æ„äº‹é …

- ãƒãƒ¼ãƒ å‰Šé™¤æ™‚ã®é–¢é€£ãƒ‡ãƒ¼ã‚¿å‡¦ç†
- æ¨©é™ãƒã‚§ãƒƒã‚¯ã®å¾¹åº•
- åŒæ™‚ç·¨é›†ã®åˆ¶å¾¡

## ğŸ·ï¸ ãƒ©ãƒ™ãƒ«
`team`, `crud`, `management`, `phase3`

## ğŸ“… ä½œæˆæ—¥
2025-09-08